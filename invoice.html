<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Invoice Management</title>
    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Your Custom CSS (Adjust path if needed) -->
    <link rel="stylesheet" href="../css/style.css"> <!-- Make sure this path is correct -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        .hidden {
            display: none !important;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.success {
             background-color: #d4edda;
             color: #155724;
             border: 1px solid #c3e6cb;
        }
        .text-right {
             text-align: right !important;
        }
        .table-wrapper {
            background: #fff;
            padding: 20px 25px;
            margin: 30px auto;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,.05);
            max-width: 1200px; /* Wider for invoice details */
        }
        .table-title h2 {
            margin: 5px 0 0;
            font-size: 24px;
        }
        .table-title .btn {
            float: right;
            height: 34px;
            font-size: 14px;
        }
        /* Style for invoice item rows in modal */
        .invoice-item-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .invoice-item-row input {
            flex-grow: 1;
        }
        .invoice-item-row .btn-remove-item {
            flex-shrink: 0;
        }
        /* Status badges */
        .badge {
            padding: 0.5em 0.75em;
            font-size: 0.8em;
        }
        .status-draft { background-color: #6c757d; } /* Secondary */
        .status-sent { background-color: #0d6efd; } /* Primary */
        .status-paid { background-color: #198754; } /* Success */
        .status-overdue { background-color: #dc3545; } /* Danger */
    </style>
</head>

<body>
    <!-- Login Section -->
    <div id="login-section">
        <div class="container"
            style="max-width: 400px; margin: 50px auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
            <h1 class="text-center">Admin Access Required</h1>
            <div id="message" class="message"></div>
            <div class="d-grid gap-2">
                <button id="netlify-login-button" class="btn btn-primary btn-lg">
                    Login with Netlify Identity
                </button>
            </div>
        </div>
    </div>

    <!-- Admin Content -->
    <div id="admin-content" class="hidden">
        <div class="container-fluid">
            <div class="table-wrapper">
                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-6">
                            <h2>KRCKA <b>Invoices</b></h2>
                            <a href="../index.html">Home</a> <!-- Make sure this path is correct -->
                        </div>
                        <div class="col-sm-6 text-right">
                            <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addInvoiceModal">
                                <i class="material-icons">&#xE147;</i> <span>Add New Invoice</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="table-responsive mt-3">
                    <table id="invoices-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Inv #</th>
                                <th>Client</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Invoice entries populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Invoice Modal -->
        <div id="addInvoiceModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addInvoiceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg"> <!-- Larger modal for invoice details -->
                <div class="modal-content">
                    <form id="add-invoice-form">
                        <div class="modal-header">
                            <h4 class="modal-title" id="addInvoiceModalLabel">Add New Invoice</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="add-client-name" class="form-label">Client Name</label>
                                    <input type="text" id="add-client-name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="add-client-email" class="form-label">Client Email</label>
                                    <input type="email" id="add-client-email" class="form-control">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="add-issue-date" class="form-label">Issue Date</label>
                                    <input type="date" id="add-issue-date" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="add-due-date" class="form-label">Due Date</label>
                                    <input type="date" id="add-due-date" class="form-control" required>
                                </div>
                            </div>
                             <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="add-invoice-number" class="form-label">Invoice Number</label>
                                    <input type="text" id="add-invoice-number" class="form-control" required placeholder="e.g., INV-001">
                                </div>
                                 <div class="col-md-6">
                                    <label for="add-status" class="form-label">Status</label>
                                    <select id="add-status" class="form-select" required>
                                        <option value="draft" selected>Draft</option>
                                        <option value="sent">Sent</option>
                                        <option value="paid">Paid</option>
                                        <option value="overdue">Overdue</option>
                                    </select>
                                </div>
                            </div>

                            <hr>
                            <h5>Invoice Items</h5>
                            <div id="add-invoice-items-container">
                                <!-- Invoice items will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-item-button">Add Item</button>

                            <hr>
                            <div class="row justify-content-end text-right">
                                <div class="col-md-4">
                                    <p><strong>Subtotal:</strong> <span id="add-subtotal">$0.00</span></p>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Tax (%)</span>
                                        <input type="number" id="add-tax-rate" class="form-control" value="0" min="0" step="0.01">
                                    </div>
                                    <p><strong>Tax:</strong> <span id="add-tax-amount">$0.00</span></p>
                                    <h5 class="mt-2"><strong>Total:</strong> <span id="add-total-amount">$0.00</span></h5>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                            <input type="submit" class="btn btn-success" value="Add Invoice">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Invoice Modal (Structure similar to Add, IDs prefixed with 'edit-') -->
        <div id="editInvoiceModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editInvoiceModalLabel" aria-hidden="true">
             <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="edit-invoice-form">
                        <div class="modal-header">
                            <h4 class="modal-title" id="editInvoiceModalLabel">Edit Invoice</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Fields similar to Add Modal, but with 'edit-' prefix -->
                             <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="edit-client-name" class="form-label">Client Name</label>
                                    <input type="text" id="edit-client-name" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="edit-client-email" class="form-label">Client Email</label>
                                    <input type="email" id="edit-client-email" class="form-control">
                                </div>
                            </div>
                             <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="edit-issue-date" class="form-label">Issue Date</label>
                                    <input type="date" id="edit-issue-date" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="edit-due-date" class="form-label">Due Date</label>
                                    <input type="date" id="edit-due-date" class="form-control" required>
                                </div>
                            </div>
                             <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="edit-invoice-number" class="form-label">Invoice Number</label>
                                    <input type="text" id="edit-invoice-number" class="form-control" required readonly> <!-- Usually non-editable -->
                                </div>
                                 <div class="col-md-6">
                                    <label for="edit-status" class="form-label">Status</label>
                                    <select id="edit-status" class="form-select" required>
                                        <option value="draft">Draft</option>
                                        <option value="sent">Sent</option>
                                        <option value="paid">Paid</option>
                                        <option value="overdue">Overdue</option>
                                    </select>
                                </div>
                            </div>

                            <hr>
                            <h5>Invoice Items</h5>
                            <div id="edit-invoice-items-container">
                                <!-- Edit invoice items -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="edit-add-item-button">Add Item</button>

                            <hr>
                             <div class="row justify-content-end text-right">
                                <div class="col-md-4">
                                    <p><strong>Subtotal:</strong> <span id="edit-subtotal">$0.00</span></p>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text">Tax (%)</span>
                                        <input type="number" id="edit-tax-rate" class="form-control" value="0" min="0" step="0.01">
                                    </div>
                                    <p><strong>Tax:</strong> <span id="edit-tax-amount">$0.00</span></p>
                                    <h5 class="mt-2"><strong>Total:</strong> <span id="edit-total-amount">$0.00</span></h5>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                            <input type="submit" class="btn btn-info" value="Save Changes">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Invoice Modal -->
        <div id="deleteInvoiceModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteInvoiceModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="delete-invoice-form">
                        <div class="modal-header">
                            <h4 class="modal-title" id="deleteInvoiceModalLabel">Delete Invoice</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this invoice?</p>
                            <p class="text-warning"><small>This action cannot be undone.</small></p>
                            <p><strong>Invoice #: <span id="delete-invoice-number-display"></span></strong></p>
                             <p><strong>Client: <span id="delete-invoice-client-display"></span></strong></p>
                        </div>
                        <div class="modal-footer">
                            <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                            <input type="submit" class="btn btn-danger" value="Delete">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div> <!-- End Admin Content -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Firebase SDK (Consider using newer v9+ modular SDK for new projects) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <!-- Netlify Identity Widget -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg",
            authDomain: "richardrccr-10a9d.firebaseapp.com",
            projectId: "richardrccr-10a9d",
            storageBucket: "richardrccr-10a9d.firebasestorage.app",
            messagingSenderId: "867270362103",
            appId: "1:867270362103:web:7653459445810350b864f2"
        };

        // --- Initialize Firebase ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- Firestore Collection Reference ---
        const invoicesRef = db.collection('invoices');

        // --- DOM Element References ---
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const netlifyLoginButton = document.getElementById('netlify-login-button');
        const messageDiv = document.getElementById('message');
        const invoicesTableBody = document.querySelector('#invoices-table tbody');

        // Add Modal Elements
        const addInvoiceForm = document.getElementById('add-invoice-form');
        const addInvoiceModalEl = document.getElementById('addInvoiceModal');
        const addItemButton = document.getElementById('add-item-button');
        const addItemsContainer = document.getElementById('add-invoice-items-container');
        const addSubtotalEl = document.getElementById('add-subtotal');
        const addTaxRateEl = document.getElementById('add-tax-rate');
        const addTaxAmountEl = document.getElementById('add-tax-amount');
        const addTotalAmountEl = document.getElementById('add-total-amount');

        // Edit Modal Elements
        const editInvoiceForm = document.getElementById('edit-invoice-form');
        const editInvoiceModalEl = document.getElementById('editInvoiceModal');
        const editAddItemButton = document.getElementById('edit-add-item-button');
        const editItemsContainer = document.getElementById('edit-invoice-items-container');
        const editSubtotalEl = document.getElementById('edit-subtotal');
        const editTaxRateEl = document.getElementById('edit-tax-rate');
        const editTaxAmountEl = document.getElementById('edit-tax-amount');
        const editTotalAmountEl = document.getElementById('edit-total-amount');

        // Delete Modal Elements
        const deleteInvoiceForm = document.getElementById('delete-invoice-form');
        const deleteInvoiceModalEl = document.getElementById('deleteInvoiceModal');
        const deleteInvoiceNumberDisplay = document.getElementById('delete-invoice-number-display');
        const deleteInvoiceClientDisplay = document.getElementById('delete-invoice-client-display');


        // --- Netlify Identity Initialization ---
        const netlifyIdentity = window.netlifyIdentity;
        if (netlifyIdentity) {
            netlifyIdentity.init();
        } else {
            console.error("Netlify Identity widget not loaded.");
            showMessage('error', 'Authentication service failed to load.');
        }

        // --- Helper Functions ---
        function showMessage(type, text) {
            if (messageDiv) {
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = text;
                messageDiv.style.display = 'block';
            } else { console.warn("Message div not found"); }
        }

        function clearMessage() {
            if (messageDiv) {
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
                messageDiv.className = 'message';
            }
        }

        function formatFirestoreTimestamp(timestamp, format = 'date') {
            if (timestamp && typeof timestamp.toDate === 'function') {
                const date = timestamp.toDate();
                 if (format === 'date') {
                    return date.toLocaleDateString(); // Adjust locale/options as needed
                 } else if (format === 'datetime') {
                     return date.toLocaleString();
                 } else if (format === 'iso') {
                     // Get date in YYYY-MM-DD format for input[type=date]
                     const year = date.getFullYear();
                     const month = (date.getMonth() + 1).toString().padStart(2, '0');
                     const day = date.getDate().toString().padStart(2, '0');
                     return `${year}-${month}-${day}`;
                 }
            }
            return 'N/A';
        }

        function formatCurrency(amount) {
            // Simple currency formatting, adjust as needed (e.g., locale, currency symbol)
            return '$' + (amount || 0).toFixed(2);
        }

        function getStatusBadge(status) {
            const statusLower = (status || 'draft').toLowerCase();
            const badgeClass = `status-${statusLower}`;
            const statusText = statusLower.charAt(0).toUpperCase() + statusLower.slice(1); // Capitalize
            return `<span class="badge ${badgeClass}">${statusText}</span>`;
        }


        // --- UI Update Logic ---
        function updateAdminUI(isAdmin) {
             if (isAdmin) {
                loginSection.classList.add('hidden');
                adminContent.classList.remove('hidden');
                clearMessage();
                displayInvoices();
            } else {
                loginSection.classList.remove('hidden');
                adminContent.classList.add('hidden');
                if (netlifyIdentity.currentUser()) {
                     showMessage('error', 'Admin access required.');
                } else {
                     clearMessage();
                }
                if (invoicesTableBody) invoicesTableBody.innerHTML = '';
            }
        }

        // --- Invoice Item Row Template ---
        function createInvoiceItemRow(containerId, item = { description: '', quantity: 1, unitPrice: 0 }) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container with ID ${containerId} not found.`);
                return;
            }

            const uniqueId = `item-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
            const row = document.createElement('div');
            row.classList.add('invoice-item-row');
            row.setAttribute('data-item-id', uniqueId);
            row.innerHTML = `
                <input type="text" class="form-control form-control-sm item-description" placeholder="Description" value="${item.description || ''}" required>
                <input type="number" class="form-control form-control-sm item-quantity" placeholder="Qty" value="${item.quantity || 1}" min="0" step="any" required style="max-width: 80px;">
                <input type="number" class="form-control form-control-sm item-unit-price" placeholder="Unit Price" value="${item.unitPrice || 0}" min="0" step="0.01" required style="max-width: 120px;">
                <span class="item-total" style="min-width: 80px; text-align: right;">${formatCurrency((item.quantity || 1) * (item.unitPrice || 0))}</span>
                <button type="button" class="btn btn-danger btn-sm btn-remove-item" title="Remove Item">&times;</button>
            `;

            container.appendChild(row);

            // Add event listeners for calculation and removal
            row.querySelector('.btn-remove-item').addEventListener('click', () => {
                row.remove();
                calculateTotals(containerId.startsWith('add') ? 'add' : 'edit'); // Recalculate after removal
            });

            row.querySelectorAll('.item-quantity, .item-unit-price').forEach(input => {
                input.addEventListener('input', () => {
                    calculateItemTotal(row);
                    calculateTotals(containerId.startsWith('add') ? 'add' : 'edit');
                });
            });

            // Initial calculation for the row just added
            calculateItemTotal(row);
        }

        function calculateItemTotal(row) {
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
            const total = quantity * unitPrice;
            row.querySelector('.item-total').textContent = formatCurrency(total);
        }

        // --- Calculate Totals (Subtotal, Tax, Total) ---
        function calculateTotals(modalPrefix) { // modalPrefix is 'add' or 'edit'
            const itemsContainer = document.getElementById(`${modalPrefix}-invoice-items-container`);
            const subtotalEl = document.getElementById(`${modalPrefix}-subtotal`);
            const taxRateEl = document.getElementById(`${modalPrefix}-tax-rate`);
            const taxAmountEl = document.getElementById(`${modalPrefix}-tax-amount`);
            const totalAmountEl = document.getElementById(`${modalPrefix}-total-amount`);

            if (!itemsContainer || !subtotalEl || !taxRateEl || !taxAmountEl || !totalAmountEl) {
                console.error("One or more total calculation elements not found for prefix:", modalPrefix);
                return;
            }

            let subtotal = 0;
            itemsContainer.querySelectorAll('.invoice-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
                subtotal += quantity * unitPrice;
            });

            const taxRate = parseFloat(taxRateEl.value) || 0;
            const taxAmount = subtotal * (taxRate / 100);
            const totalAmount = subtotal + taxAmount;

            subtotalEl.textContent = formatCurrency(subtotal);
            taxAmountEl.textContent = formatCurrency(taxAmount);
            totalAmountEl.textContent = formatCurrency(totalAmount);
        }

        // --- Process Pending Items from Mashgiach Logs ---
        function processPendingInvoiceItems() {
            const pendingItemsJson = sessionStorage.getItem('pendingInvoiceItems');
            if (pendingItemsJson) {
                try {
                    const pendingItems = JSON.parse(pendingItemsJson);
                    console.log("Found pending items in sessionStorage:", pendingItems);

                    if (Array.isArray(pendingItems) && pendingItems.length > 0) {
                        // Ensure the items container exists
                        if (!addItemsContainer) {
                            console.error("Add invoice items container not found!");
                            sessionStorage.removeItem('pendingInvoiceItems'); // Clear storage even if container missing
                            return;
                        }

                        // Add each pending item to the modal
                        pendingItems.forEach(item => {
                            // Use default values if properties are missing
                            const invoiceItem = {
                                description: item.description || 'Log Item',
                                quantity: item.quantity || 1,
                                unitPrice: item.unitPrice || 0
                            };
                            createInvoiceItemRow('add-invoice-items-container', invoiceItem);
                        });

                        // Recalculate totals *after* adding all items
                        calculateTotals('add');

                        // IMPORTANT: Clear the items from storage once processed
                        sessionStorage.removeItem('pendingInvoiceItems');
                        console.log("Pending items processed and removed from sessionStorage.");
                    } else {
                        // If data is invalid or empty, just remove it
                        sessionStorage.removeItem('pendingInvoiceItems');
                    }

                } catch (error) {
                    console.error("Error processing pending invoice items:", error);
                    // Clear storage in case of parsing error
                    sessionStorage.removeItem('pendingInvoiceItems');
                }
            } else {
                console.log("No pending invoice items found in sessionStorage.");
            }
        }


        // --- Firestore Operations ---

        // Add Invoice
        async function addInvoiceSubmit(event) {
            event.preventDefault();
            const user = netlifyIdentity.currentUser();
            if (!user) {
                showMessage('error', "You must be logged in.");
                return;
            }

            // Collect basic invoice data
            const invoiceData = {
                invoiceNumber: document.getElementById('add-invoice-number').value.trim(),
                clientName: document.getElementById('add-client-name').value.trim(),
                clientEmail: document.getElementById('add-client-email').value.trim(),
                issueDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('add-issue-date').value)),
                dueDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('add-due-date').value)),
                status: document.getElementById('add-status').value,
                taxRate: parseFloat(document.getElementById('add-tax-rate').value) || 0,
                items: [],
                subtotal: 0,
                taxAmount: 0,
                totalAmount: 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: user.user_metadata?.full_name || user.email,
                createdById: user.id
            };

            // Collect invoice items
            let currentSubtotal = 0;
            addItemsContainer.querySelectorAll('.invoice-item-row').forEach(row => {
                const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
                const itemTotal = quantity * unitPrice;
                invoiceData.items.push({
                    description: row.querySelector('.item-description').value.trim(),
                    quantity: quantity,
                    unitPrice: unitPrice,
                    total: itemTotal // Store calculated item total
                });
                currentSubtotal += itemTotal;
            });

            // Calculate final totals based on items and tax rate
            invoiceData.subtotal = currentSubtotal;
            invoiceData.taxAmount = currentSubtotal * (invoiceData.taxRate / 100);
            invoiceData.totalAmount = invoiceData.subtotal + invoiceData.taxAmount;

             if (!invoiceData.invoiceNumber || !invoiceData.clientName || !invoiceData.issueDate || !invoiceData.dueDate || invoiceData.items.length === 0) {
                 alert("Please fill in all required fields (Invoice #, Client Name, Dates) and add at least one item.");
                 return;
             }

            try {
                await invoicesRef.add(invoiceData);
                console.log("Invoice added.");

                const addModalInstance = bootstrap.Modal.getInstance(addInvoiceModalEl);
                if(addModalInstance) addModalInstance.hide();

                // Form reset and item clearing is handled by 'hidden.bs.modal' event

                displayInvoices(); // Refresh table

            } catch (error) {
                console.error("Error adding invoice: ", error);
                showMessage('error', `Failed to add invoice: ${error.message}`);
            }
        }

        // Display Invoices
        async function displayInvoices() {
            if (!invoicesTableBody) return;
            invoicesTableBody.innerHTML = '<tr><td colspan="7">Loading invoices...</td></tr>';

            try {
                // Order by issue date descending
                const querySnapshot = await invoicesRef.orderBy('issueDate', 'desc').get();

                if (querySnapshot.empty) {
                    invoicesTableBody.innerHTML = '<tr><td colspan="7">No invoices found.</td></tr>';
                    return;
                }

                let tableContent = '';
                querySnapshot.forEach(doc => {
                    const inv = doc.data();
                    const invId = doc.id;

                    tableContent += `
                        <tr data-id="${invId}">
                            <td>${inv.invoiceNumber || 'N/A'}</td>
                            <td>${inv.clientName || 'N/A'}</td>
                            <td>${formatFirestoreTimestamp(inv.issueDate, 'date')}</td>
                            <td>${formatFirestoreTimestamp(inv.dueDate, 'date')}</td>
                            <td>${formatCurrency(inv.totalAmount)}</td>
                            <td>${getStatusBadge(inv.status)}</td>
                            <td>
                                <a href="#" class="edit js-edit-invoice" data-id="${invId}" title="Edit Invoice">
                                    <i class="material-icons">&#xE254;</i>
                                </a>
                                <a href="#" class="delete js-delete-invoice" data-id="${invId}" title="Delete Invoice">
                                    <i class="material-icons">&#xE872;</i>
                                </a>
                                <!-- Add View/Print button later if needed -->
                            </td>
                        </tr>
                    `;
                });

                invoicesTableBody.innerHTML = tableContent;

            } catch (error) {
                console.error("Error fetching invoices: ", error);
                invoicesTableBody.innerHTML = `<tr><td colspan="7" class="text-danger">Error loading invoices: ${error.message}</td></tr>`;
            }
        }

        // Open Edit Modal
        async function openEditInvoiceModal(invoiceId) {
            editInvoiceForm.setAttribute('data-edit-id', invoiceId);
            editItemsContainer.innerHTML = ''; // Clear previous items

             try {
                const doc = await invoicesRef.doc(invoiceId).get();
                if (doc.exists) {
                    const invData = doc.data();

                    // Populate basic fields
                    document.getElementById('edit-invoice-number').value = invData.invoiceNumber || '';
                    document.getElementById('edit-client-name').value = invData.clientName || '';
                    document.getElementById('edit-client-email').value = invData.clientEmail || '';
                    document.getElementById('edit-issue-date').value = formatFirestoreTimestamp(invData.issueDate, 'iso');
                    document.getElementById('edit-due-date').value = formatFirestoreTimestamp(invData.dueDate, 'iso');
                    document.getElementById('edit-status').value = invData.status || 'draft';
                    document.getElementById('edit-tax-rate').value = invData.taxRate || 0;

                    // Populate items
                    if (invData.items && Array.isArray(invData.items)) {
                        invData.items.forEach(item => createInvoiceItemRow('edit-invoice-items-container', item));
                    }

                    calculateTotals('edit'); // Calculate totals based on loaded data

                    const editModal = bootstrap.Modal.getOrCreateInstance(editInvoiceModalEl);
                    editModal.show();
                } else {
                    console.error("Invoice document not found for editing:", invoiceId);
                    showMessage('error', 'Could not find the invoice to edit.');
                }
            } catch (error) {
                console.error("Error getting document for edit:", error);
                 showMessage('error', `Error loading invoice for editing: ${error.message}`);
            }
        }

        // Submit Edit Invoice
        async function editInvoiceSubmit(event) {
            event.preventDefault();
            const invoiceId = editInvoiceForm.getAttribute('data-edit-id');
            if (!invoiceId) return;

             const user = netlifyIdentity.currentUser(); // Needed for updatedAtBy etc. if desired

            // Collect updated data (similar to addInvoiceSubmit)
             const updatedData = {
                // invoiceNumber is usually not editable
                clientName: document.getElementById('edit-client-name').value.trim(),
                clientEmail: document.getElementById('edit-client-email').value.trim(),
                issueDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('edit-issue-date').value)),
                dueDate: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('edit-due-date').value)),
                status: document.getElementById('edit-status').value,
                taxRate: parseFloat(document.getElementById('edit-tax-rate').value) || 0,
                items: [],
                subtotal: 0,
                taxAmount: 0,
                totalAmount: 0,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                // updatedBy: user.user_metadata?.full_name || user.email // Optional
            };

            let currentSubtotal = 0;
            editItemsContainer.querySelectorAll('.invoice-item-row').forEach(row => {
                 const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
                const itemTotal = quantity * unitPrice;
                updatedData.items.push({
                    description: row.querySelector('.item-description').value.trim(),
                    quantity: quantity,
                    unitPrice: unitPrice,
                    total: itemTotal
                });
                currentSubtotal += itemTotal;
            });

            updatedData.subtotal = currentSubtotal;
            updatedData.taxAmount = currentSubtotal * (updatedData.taxRate / 100);
            updatedData.totalAmount = updatedData.subtotal + updatedData.taxAmount;

             if (!updatedData.clientName || !updatedData.issueDate || !updatedData.dueDate || updatedData.items.length === 0) {
                 alert("Please fill in all required fields (Client Name, Dates) and add at least one item.");
                 return;
             }

            try {
                await invoicesRef.doc(invoiceId).update(updatedData);

                const editModalInstance = bootstrap.Modal.getInstance(editInvoiceModalEl);
                if(editModalInstance) editModalInstance.hide();

                // Form reset handled by 'hidden.bs.modal'
                displayInvoices(); // Refresh table

            } catch (error) {
                console.error("Error updating invoice: ", error);
                showMessage('error', `Error saving changes: ${error.message}`);
            }
        }

         // Open Delete Modal
        async function openDeleteInvoiceModal(invoiceId) {
            deleteInvoiceForm.setAttribute('data-delete-id', invoiceId);
             // Fetch minimal data to display in the confirmation
             try {
                 const doc = await invoicesRef.doc(invoiceId).get();
                 if (doc.exists) {
                     const invData = doc.data();
                     deleteInvoiceNumberDisplay.textContent = invData.invoiceNumber || 'N/A';
                     deleteInvoiceClientDisplay.textContent = invData.clientName || 'N/A';
                 } else {
                     deleteInvoiceNumberDisplay.textContent = 'Error';
                     deleteInvoiceClientDisplay.textContent = 'Invoice not found';
                 }
             } catch (error) {
                 deleteInvoiceNumberDisplay.textContent = 'Error';
                 deleteInvoiceClientDisplay.textContent = 'Could not load details';
             }

            const deleteModal = bootstrap.Modal.getOrCreateInstance(deleteInvoiceModalEl);
            deleteModal.show();
        }


        // Submit Delete
        async function deleteInvoiceSubmit(event) {
            event.preventDefault();
            const invoiceId = deleteInvoiceForm.getAttribute('data-delete-id');
             if (!invoiceId) return;

            try {
                await invoicesRef.doc(invoiceId).delete();
                console.log("Invoice successfully deleted!");

                const deleteModalInstance = bootstrap.Modal.getInstance(deleteInvoiceModalEl);
                if(deleteModalInstance) deleteModalInstance.hide();

                // Attribute removal handled by 'hidden.bs.modal'
                displayInvoices(); // Refresh table

            } catch (error) {
                console.error("Error deleting invoice: ", error);
                 showMessage('error', `Error deleting invoice: ${error.message}`);
            }
        }


        // --- Event Listeners ---

        // Netlify Identity Login Button
        if (netlifyLoginButton) {
            netlifyLoginButton.addEventListener('click', () => {
                netlifyIdentity.open();
            });
        }

        // Netlify Identity Events
        netlifyIdentity.on('init', user => {
            const isAdmin = user?.app_metadata?.roles?.includes('admin') ?? false;
            updateAdminUI(isAdmin);
        });

        netlifyIdentity.on('login', user => {
            const isAdmin = user?.app_metadata?.roles?.includes('admin') ?? false;
            updateAdminUI(isAdmin);
            netlifyIdentity.close();
        });

        netlifyIdentity.on('logout', () => {
            updateAdminUI(false);
        });

        // Form Submissions
        if (addInvoiceForm) addInvoiceForm.addEventListener('submit', addInvoiceSubmit);
        if (editInvoiceForm) editInvoiceForm.addEventListener('submit', editInvoiceSubmit);
        if (deleteInvoiceForm) deleteInvoiceForm.addEventListener('submit', deleteInvoiceSubmit);

        // Add Item Buttons
        if (addItemButton) {
            addItemButton.addEventListener('click', () => {
                createInvoiceItemRow('add-invoice-items-container');
                calculateTotals('add'); // Recalculate if a blank row is added
            });
        }
         if (editAddItemButton) {
            editAddItemButton.addEventListener('click', () => {
                createInvoiceItemRow('edit-invoice-items-container');
                 calculateTotals('edit'); // Recalculate if a blank row is added
            });
        }

        // Calculate totals when tax rate changes
        if(addTaxRateEl) addTaxRateEl.addEventListener('input', () => calculateTotals('add'));
        if(editTaxRateEl) editTaxRateEl.addEventListener('input', () => calculateTotals('edit'));


        // Event Delegation for Edit/Delete buttons in the table
        if (invoicesTableBody) {
            invoicesTableBody.addEventListener('click', (event) => {
                const targetLink = event.target.closest('a'); // Find the closest link
                if (!targetLink) return;

                const invoiceId = targetLink.getAttribute('data-id');
                if (!invoiceId) return;

                if (targetLink.classList.contains('js-edit-invoice')) {
                    event.preventDefault();
                    openEditInvoiceModal(invoiceId);
                } else if (targetLink.classList.contains('js-delete-invoice')) {
                     event.preventDefault();
                    openDeleteInvoiceModal(invoiceId);
                }
            });
        }

        // Modal Event Listeners
        if(addInvoiceModalEl) {
            // Process pending items when Add modal is about to show
            addInvoiceModalEl.addEventListener('show.bs.modal', () => {
                console.log("Add Invoice Modal opening, checking for pending items...");
                processPendingInvoiceItems();
            });
            // Reset form and clear items when Add modal is hidden
            addInvoiceModalEl.addEventListener('hidden.bs.modal', () => {
                addInvoiceForm.reset();
                addItemsContainer.innerHTML = '';
                calculateTotals('add'); // Reset totals display
            });
        }

        if(editInvoiceModalEl) {
            // Reset form and clear items when Edit modal is hidden
            editInvoiceModalEl.addEventListener('hidden.bs.modal', () => {
                editInvoiceForm.reset();
                editItemsContainer.innerHTML = '';
                editInvoiceForm.removeAttribute('data-edit-id');
                 // No need to recalculate totals on close, just reset
            });
        }

        if(deleteInvoiceModalEl) {
             // Reset delete confirmation when Delete modal is hidden
            deleteInvoiceModalEl.addEventListener('hidden.bs.modal', () => {
                deleteInvoiceForm.removeAttribute('data-delete-id');
                deleteInvoiceNumberDisplay.textContent = '';
                deleteInvoiceClientDisplay.textContent = '';
            });
        }

        // --- Initial Load ---
        // Handled by Netlify Identity 'init' event

    </script>
</body>
</html>
