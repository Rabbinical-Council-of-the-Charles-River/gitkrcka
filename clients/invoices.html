<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Invoices</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #fff; }
        .status-draft { background-color: #6c757d; }
        .status-sent { background-color: #0d6efd; }
        .status-paid { background-color: #198754; }
        .status-overdue { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid p-3">
        <div id="loading-state" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your invoices...</p>
        </div>

        <div id="error-state" class="alert alert-danger" style="display: none;"></div>

        <div id="invoices-table-container" class="table-responsive" style="display: none;">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>Invoice #</th>
                        <th>Issue Date</th>
                        <th>Due Date</th>
                        <th class="text-end">Amount</th>
                        <th class="text-center">Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="invoices-tbody">
                    <!-- Rows will be injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Netlify Identity -->
    <script src="https://cdn.jsdelivr.net/npm/netlify-identity-widget@1.9.1/build/netlify-identity-widget.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg",
            authDomain: "richardrccr-10a9d.firebaseapp.com",
            projectId: "richardrccr-10a9d",
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const loadingEl = document.getElementById('loading-state');
        const errorEl = document.getElementById('error-state');
        const tableContainerEl = document.getElementById('invoices-table-container');
        const tbodyEl = document.getElementById('invoices-tbody');

        function showError(message) {
            loadingEl.style.display = 'none';
            tableContainerEl.style.display = 'none';
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
        }

        function formatDate(timestamp) {
            if (!timestamp || !timestamp.toDate) return 'N/A';
            return timestamp.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function getStatusBadge(status) {
            const statusLower = (status || 'draft').toLowerCase();
            const badgeClass = `status-${statusLower}`;
            const statusText = statusLower.charAt(0).toUpperCase() + statusLower.slice(1);
            return `<span class="badge ${badgeClass}">${statusText}</span>`;
        }

        async function loadInvoices(userEmail) {
            if (!userEmail) {
                showError("Could not identify user. Please log in again.");
                return;
            }

            try {
                const snapshot = await db.collection('invoices')
                    .where('clientEmail', '==', userEmail)
                    .orderBy('issueDate', 'desc')
                    .get();

                loadingEl.style.display = 'none';

                if (snapshot.empty) {
                    tbodyEl.innerHTML = '<tr><td colspan="6" class="text-center text-muted p-4">No invoices found for your account.</td></tr>';
                } else {
                    tbodyEl.innerHTML = snapshot.docs.map(doc => {
                        const invoice = doc.data();
                        const isPaid = (invoice.status || '').toLowerCase() === 'paid';
                        return `
                            <tr>
                                <td>${invoice.invoiceNumber || 'N/A'}</td>
                                <td>${formatDate(invoice.issueDate)}</td>
                                <td>${formatDate(invoice.dueDate)}</td>
                                <td class="text-end">${formatCurrency(invoice.totalAmount)}</td>
                                <td class="text-center">${getStatusBadge(invoice.status)}</td>
                                <td class="text-end">
                                    <a href="../invoice-print.html?id=${doc.id}" target="_blank" class="btn btn-sm btn-outline-secondary" title="View/Print">
                                        <i class="bi bi-printer"></i>
                                    </a>
                                    ${!isPaid ? `
                                    <a href="../payment.html?invoiceId=${invoice.invoiceNumber}" target="_parent" class="btn btn-sm btn-success" title="Make Payment">
                                        <i class="bi bi-credit-card"></i> Pay
                                    </a>` : ''}
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                tableContainerEl.style.display = 'block';
            } catch (err) {
                showError(`Error loading invoices: ${err.message}`);
                console.error(err);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // This script runs inside an iframe, so we access the parent's netlifyIdentity
            if (window.parent && window.parent.netlifyIdentity) {
                const user = window.parent.netlifyIdentity.currentUser();
                if (user && user.email) {
                    loadInvoices(user.email);
                } else {
                    showError("You must be logged in to view your invoices.");
                }
            } else {
                showError("Could not access authentication service from the portal.");
            }
        });
    </script>
</body>
</html>
