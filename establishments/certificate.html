<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kosher Certificate</title>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            background: #f4f4f4;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Make the body take up the full viewport height */
        }

        @media print {
            body {
                background: white !important; /* Ensure white background when printing */
            }
            .left-panel {
                background-color: black !important;
                color: white !important;
            }
            .validity {
                background-color: black !important;
                color: white !important;
            }
        }

        .certificate {
            display: flex;
            background: white;
            border: 5px solid #1f2c4d;
            box-sizing: border-box;
            
            /* Fixed dimensions for non-responsive layout */
            width: 1056px; /* Approx. 11 inches at 96 DPI */
            height: 816px; /* Approx. 8.5 inches at 96 DPI */
            flex-shrink: 0; /* Prevent shrinking in flex container (body) */

            /* Centered by body's flex properties */
            /* margin-top: 8vh; */ /* Removed for pure flex centering, can be a fixed px value if offset needed */
        }
        /* Default (Blue Scheme) - applied via base styles of .left-panel and .validity */
        /* The .certificate itself has a default blue border set above */

        /* Red Scheme */
        .certificate.scheme-red { border-color: #8B0000; }
        .certificate.scheme-red .left-panel,
        .certificate.scheme-red .validity { background-color: #8B0000; color: white; }

        /* Green Scheme */
        .certificate.scheme-green { border-color: #006400; }
        .certificate.scheme-green .left-panel,
        .certificate.scheme-green .validity { background-color: #006400; color: white; }

        /* Red-Blue Scheme */
        .certificate.scheme-red-blue { border-color: #8B0000; } /* Main border red (matches left panel) */
        .certificate.scheme-red-blue .left-panel { background-color: #8B0000; color: white; }
        .certificate.scheme-red-blue .validity { background-color: #1f2c4d; color: white; }

        /* Green-Red Scheme */
        .certificate.scheme-green-red { border-color: #006400; } /* Main border green (matches left panel) */
        .certificate.scheme-green-red .left-panel { background-color: #006400; color: white; } /* Green */
        .certificate.scheme-green-red .validity { background-color: #8B0000; color: white; } /* Red */

        /* Blue scheme (explicit for clarity, though defaults might match) */
        .certificate.scheme-blue { border-color: #1f2c4d; }
        .certificate.scheme-blue .left-panel, .certificate.scheme-blue .validity { background-color: #1f2c4d; color: white; }

        .left-panel {
            width: 35%; /* Increased width to make sidebar bigger */
            background-color: #1f2c4d; /* Default, overridden by schemes */
            color: white;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        .left-panel img {
            max-width: 80%; /* Adjust image size within the panel */
            margin: 15px 0 10px 0; /* Adjusted margins around image */
        }

        .left-panel h3, .left-panel p {
            text-align: center;
            margin-bottom: 10px; /* Add some spacing */
        }
        .left-panel h3 { font-size: 2em; line-height: 1.3; margin-bottom: 15px;} /* Significantly larger heading size, adjusted line height & margin */
        .left-panel p { font-size: 1.2em; line-height: 1.4; margin-bottom: 12px;} /* Significantly larger paragraph text, adjusted line height & margin */

        .right-panel {
            width: 65%; /* Decreased width to accommodate larger left panel */
            padding: 40px;
            box-sizing: border-box;
            display: flex; /* Added flex to help distribute space */
            flex-direction: column; /* Stack content vertically */
            justify-content: space-around; /* Distribute space more evenly */
        }

        .header-hebrew {
            text-align: right;
            font-size: 18px; /* Larger */
            margin-bottom: 10px;
        }

        .title {
            text-align: center;
            font-size: 40px; /* Significantly larger title */
            font-style: italic;
            margin-bottom: 10px;
        }

        .certify-text {
            text-align: center;
            font-size: 24px; /* Significantly larger main text */
            margin-bottom: 20px; /* Adjust spacing */
        }

        .establishment {
            font-size: 34px; /* Significantly larger establishment name */
            font-weight: bold;
        }

        .classification {
            text-align: center;
            font-size: 28px; /* Significantly larger classification */
            font-weight: bold;
            margin: 20px 0;
        }

        .validity {
            background-color: #1f2c4d; /* Default, overridden by schemes */
            color: white;
            font-size: 24px; /* Significantly larger validity text */
            text-align: center;
            padding: 10px;
            margin-top: 20px;
        }

        .notes {
            font-size: 18px; /* Larger notes */
            margin-top: 30px;
            text-align: center;
        }

        .signature {
            margin-top: 40px;
            text-align: left;
        }

        .signature-name {
            font-family: Pinyon Script;
            font-size: 30px; /* Significantly larger signature name */
        }

        .footer-right {
            font-size: 15px; /* Larger footer */
            text-align: right;
            margin-top: 30px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="certificate">
        <div class="left-panel">
            <div>
                <h3>לשכת הכשרות<br>שייע הבד"ץ</h3>
                <p>Kashrus Division<br>of the Rabbinical Council<br>of Charles River</p>
                <!-- Ensure the image path is correct relative to certificate.html -->
                <center><img src="../images/VAAD HARABONIM CHARLES RIVER REB CHARDLE SHATZLABAM (1).png" alt="Star of David"></center>
                <div>
                   <center> <strong>kusher reb chardle<br>kusher agency</strong></center>
                    <p>krcka.rebchardle.org<br>info@rebchardle.org<br>+1(617) 506 9578</p>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="header-hebrew" id="certificateDate">
                <!-- Date will be filled by JavaScript -->
            </div>
            <div class="title">
                Kosher Certificate
            </div>
            <div class="certify-text">
                This is to certify that<br><br>
                <span class="establishment" id="establishmentName">Establishment Name</span><br><br>
                is under our Supervision and is a certified establishment classified as:
            </div>
            <div class="classification" id="kosherClassification">
                Kosher Status
            </div>
            <div class="validity">
                Valid: March 13, 2025 ~ April 11, 2026
            </div>
            <div class="notes">
                Certification does NOT include Passover (unless otherwise specified)<br>
                Delivered items certified Kosher only if Kosher tape / seal is intact
            </div>
            <div class="signature">
                <div class="signature-name">Reb Chardle</div>
                <div>Kashrus Administrator</div>
            </div>
            <div class="footer-right">
                This certificate is the property of the<br>
                Kusher Reb Chardle Kusher Agency<br>
                and may be recalled at any time<br>
                For retail display only.
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <!-- Modal for Status Messages - Now always visible -->
    <div id="statusModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgb(255, 255, 255); z-index: 10000; justify-content: center; align-items: center; text-align: center; color: rgb(0, 0, 0); font-size: 20px; font-family: Arial, sans-serif;">
        <div id="statusModalContent" style="background-color: #ffffff; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);">
            <!-- Content will be set by JavaScript -->
            <p>Initializing Certificate...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <!-- PDF Generation Libraries -->
    <!-- html2canvas for rendering HTML element to canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for creating PDF document -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // TODO: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg",
      authDomain: "richardrccr-10a9d.firebaseapp.com",
      projectId: "richardrccr-10a9d",
      storageBucket: "richardrccr-10a9d.firebasestorage.app",
      messagingSenderId: "867270362103",
      appId: "1:867270362103:web:7653459445810350b864f2"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        /**
         * Applies a color scheme to the certificate based on kosher statuses.
         * Rules (evaluated in order of specificity):
         * 1. CY + PY + Glatt + Parve: Green/Red scheme
         * 2. Glatt + CY: Red/Blue scheme
         * 3. CY + PY: Blue scheme
         * 4. Glatt (alone or with PY/Parve, but not CY): Red scheme
         * 5. Pas Yisroel (alone or with Parve, but not CY/Glatt): Green scheme
         * 6. Cholov Yisroel (alone or with Parve): Blue scheme
         * 7. Parve (alone): Green scheme
         * 8. Default/Fallback: Blue scheme
         */
        function applyCertificateColorScheme(statuses) {
            const certificateElement = document.querySelector('.certificate');
            if (!certificateElement) return;

            // Ensure .left-panel and .validity elements exist if they are to be styled directly
            // For this approach, we add a class to .certificate and use CSS descendant selectors.

            const has = (status) => Array.isArray(statuses) && statuses.includes(status);

            const isCholovYisroel = has("Cholov Yisrael");
            const isPasYisroel = has("Pas Yisroel");
            const isGlatt = has("Glatt");
            const isParve = has("Parve");

            certificateElement.className = 'certificate'; // Reset to base class

            if (isCholovYisroel && isPasYisroel && isGlatt && isParve) {
                certificateElement.classList.add('scheme-green-red');
            }
            else if (isGlatt && isCholovYisroel) {
                certificateElement.classList.add('scheme-red-blue');
            }
            else if (isCholovYisroel && isPasYisroel) { // Implies !isGlatt
                certificateElement.classList.add('scheme-blue');
            }
            else if (isGlatt) { // Implies !isCholovYisroel
                certificateElement.classList.add('scheme-red');
            }
            else if (isPasYisroel) { // Implies !isCholovYisroel and !isGlatt
                certificateElement.classList.add('scheme-green');
            }
            else if (isCholovYisroel) { // Implies !isPasYisroel and !isGlatt
                 certificateElement.classList.add('scheme-blue');
            }
            else if (isParve) { // Implies !isCholovYisroel, !isPasYisroel, !isGlatt
                certificateElement.classList.add('scheme-green');
            }
            else { // Default
                certificateElement.classList.add('scheme-blue');
            }
        }

        function generateAndDownloadPDF(establishmentName) {
            const certificateElement = document.querySelector('.certificate');
            const statusModal = document.getElementById('statusModal');
            const statusModalContent = document.getElementById('statusModalContent');

            if (!certificateElement) {
                console.error('Certificate element not found for PDF generation!');
                if (statusModal && statusModalContent) {
                    statusModalContent.innerHTML = `
                        <p>Page Error</p>
                        <p style="font-size: 16px;">Certificate element not found. Cannot generate PDF.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #dc3545; color: white; border: none; border-radius: 5px;">Close Window</button>
                    `;
                }
                return;
            }

            // Check if html2canvas is loaded
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas library is not loaded correctly.');
                alert('Error: PDF generation component (html2canvas) failed to load. Cannot download certificate.');
                if (statusModal && statusModalContent) {
                    statusModalContent.innerHTML = `
                        <p>Critical Error</p>
                        <p style="font-size: 16px;">PDF generation component (html2canvas) failed to load.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #dc3545; color: white; border: none; border-radius: 5px;">Close Window</button>
                    `;
                }
                return;
            }

            // Check if jsPDF is loaded
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF !== 'function') {
                console.error('jsPDF library is not loaded correctly.');
                alert('Error: PDF generation library (jsPDF) failed to load. Cannot download certificate.');
                if (statusModal && statusModalContent) {
                    statusModalContent.innerHTML = `
                        <p>Critical Error</p>
                        <p style="font-size: 16px;">PDF generation library (jsPDF) failed to load.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #dc3545; color: white; border: none; border-radius: 5px;">Close Window</button>
                    `;
                }
                return;
            }

            if (statusModal && statusModalContent) {
                // Modal is already visible due to CSS, this just updates content
                statusModalContent.innerHTML = `
                    <p>Generating Certificate PDF...</p>
                    <p style="font-size: 16px;">Your download will begin shortly.</p>
                `;
                // statusModal.style.display = 'flex'; // This line is redundant as modal is always flex
            } else {
                console.warn('Status modal element not found. Proceeding without it.');
            }

            console.log('Starting PDF generation for:', establishmentName);


            html2canvas(certificateElement, {
                scale: 2, // Increase scale for better resolution in PDF
                useCORS: true, // Important if images are from other domains (though local here)
                logging: true // Enable logging for debugging html2canvas
            }).then(canvas => {
                console.log('Canvas created, width:', canvas.width, 'height:', canvas.height);
                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf; // Destructure for clarity and ensure it's available
                const pdf = new jsPDF({
                    orientation: 'landscape', // Certificate design is landscape
                    unit: 'pt',             // Use points for page dimensions
                    format: 'letter'        // Standard letter size (landscape: 792pt x 612pt)
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();    // Letter landscape width in points (e.g., 792pt)
                const pdfHeight = pdf.internal.pageSize.getHeight();  // Letter landscape height in points (e.g., 612pt)

                const canvasAspectRatio = canvas.width / canvas.height;
                
                let imgFinalWidth, imgFinalHeight;

                // Determine if image should be scaled by width or height to fit PDF page
                // This ensures the image fits within the PDF page while maintaining aspect ratio.
                if ((pdfWidth / pdfHeight) > canvasAspectRatio) {
                    imgFinalHeight = pdfHeight;
                    imgFinalWidth = pdfHeight * canvasAspectRatio;
                } else {
                    imgFinalWidth = pdfWidth;
                    imgFinalHeight = pdfWidth / canvasAspectRatio;
                }
                
                const xOffset = (pdfWidth - imgFinalWidth) / 2;
                const yOffset = (pdfHeight - imgFinalHeight) / 2;

                pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgFinalWidth, imgFinalHeight);
                const safeEstablishmentName = establishmentName ? establishmentName.replace(/[^a-z0-9_]+/gi, '_').toLowerCase() : 'kosher_certificate';
                const fileName = `${safeEstablishmentName}_certificate.pdf`;
                pdf.save(fileName);
                console.log('PDF saved as:', fileName);

                if (statusModal && statusModalContent) {
                    statusModalContent.innerHTML = `
                        <p>Download Completed!</p>
                        <p style="font-size: 16px;">${fileName} has been downloaded.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px;">Close Window</button>
                    `;
                } else {
                    alert('Download completed. You may now close this window.');
                }
            }).catch(err => {
                console.error('Error generating PDF:', err);
                if (statusModal && statusModalContent) {
                     statusModalContent.innerHTML = `
                        <p>Error Generating PDF</p>
                        <p style="font-size: 16px;">An error occurred. Please try again or check the console.</p>
                        <button onclick="window.close()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #dc3545; color: white; border: none; border-radius: 5px;">Close Window</button>
                    `;
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const establishmentId = urlParams.get('id');

            const establishmentNameEl = document.getElementById('establishmentName');
            const kosherClassificationEl = document.getElementById('kosherClassification');
            const certificateDateEl = document.getElementById('certificateDate');
            let pdfFileName = 'kosher_certificate'; // Default PDF filename

            // Set the current date
            const currentDate = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            certificateDateEl.textContent = currentDate.toLocaleDateString('en-US', dateOptions);
            // If you want to add a Hebrew date here as well, you'd need a library or custom function
            // to generate it. For now, it will just be the Gregorian date.

            if (establishmentId) {
                db.collection('establishments').doc(establishmentId).get()
                    .then(doc => {
                        // let establishmentDataForPdf; // Not strictly needed here if only name is used for PDF
                        if (doc.exists) {
                            const establishment = doc.data();
                            // establishmentDataForPdf = establishment; // Store if more data needed for PDF generation step
                            establishmentNameEl.textContent = establishment.name;
                            const status = establishment.kosherStatus;
                            if (Array.isArray(status) && status.length > 0) {
                                kosherClassificationEl.innerHTML = status.join('<br>');
                            } else if (typeof status === 'string' && status.trim() !== '') {
                                kosherClassificationEl.innerHTML = status;
                            } else {
                                kosherClassificationEl.innerHTML = 'N/A';
                            }
                            applyCertificateColorScheme(establishment.kosherStatus);
                            pdfFileName = establishment.name;
                        } else {
                            console.error("No such document for ID:", establishmentId);
                            establishmentNameEl.textContent = "Establishment not found";
                            kosherClassificationEl.textContent = "-";
                            applyCertificateColorScheme(null); // Apply default scheme
                            pdfFileName = "establishment_not_found";
                        }
                        generateAndDownloadPDF(pdfFileName);
                    })
                    .catch(error => {
                        console.error("Error getting document:", error);
                        establishmentNameEl.textContent = "Error loading data";
                        kosherClassificationEl.textContent = "-";
                        applyCertificateColorScheme(null); // Apply default scheme
                        pdfFileName = "error_loading_data";
                        generateAndDownloadPDF(pdfFileName);
                    });
            } else {
                console.error("No establishment ID provided in URL.");
                establishmentNameEl.textContent = "No ID provided";
                kosherClassificationEl.textContent = "-";
                pdfFileName = "no_id_provided";
                applyCertificateColorScheme(null); // Apply default scheme
                generateAndDownloadPDF(pdfFileName);
            }
        });
    </script>
</body>
</html>
