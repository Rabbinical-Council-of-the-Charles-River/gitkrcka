<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kosher Certificate</title>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            background: #f4f4f4;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Make the body take up the full viewport height */
        }

        @media print {
            body {
                background: white !important; /* Ensure white background when printing */
            }
            .left-panel {
                background-color: black !important;
                color: white !important;
            }
            .validity {
                background-color: black !important;
                color: white !important;
            }
        }

        .certificate {
            display: flex;
            width: 95vw; /* Make the certificate take up most of the viewport width */
            max-width: 1000px;
            background: white;
            border: 5px solid #1f2c4d;
            box-sizing: border-box; /* Ensure padding and border are included in the width */
        }

        .left-panel {
            width: 35%; /* Adjust width for better balance on full screen */
            background-color: #1f2c4d;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }

        .left-panel img {
            max-width: 80%; /* Adjust image size within the panel */
            margin: 20px 0;
        }

        .left-panel h3, .left-panel p {
            text-align: center;
            margin-bottom: 10px; /* Add some spacing */
        }

        .right-panel {
            width: 65%; /* Adjust width to complement the left panel */
            padding: 40px;
            box-sizing: border-box;
        }

        .header-hebrew {
            text-align: right;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .title {
            text-align: center;
            font-size: 28px;
            font-style: italic;
            margin-bottom: 10px;
        }

        .certify-text {
            text-align: center;
            font-size: 18px;
            margin-bottom: 30px;
        }

        .establishment {
            font-size: 24px;
            font-weight: bold;
        }

        .classification {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0;
        }

        .validity {
            background-color: #1f2c4d;
            color: white;
            font-size: 18px;
            text-align: center;
            padding: 10px;
            margin-top: 20px;
        }

        .notes {
            font-size: 14px;
            margin-top: 30px;
            text-align: center;
        }

        .signature {
            margin-top: 40px;
            text-align: left;
        }

        .signature-name {
            font-family: Pinyon Script;
            font-size: 20px;
        }

        .footer-right {
            font-size: 12px;
            text-align: right;
            margin-top: 30px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="certificate">
        <div class="left-panel">
            <div>
                <h3>לשכת הכשרות<br>שייע הבד"ץ</h3>
                <p>Kashrus Division<br>of the Rabbinical Council<br>of Charles River</p>
                <!-- Ensure the image path is correct relative to certificate.html -->
                <center><img src="../images/VAAD HARABONIM CHARLES RIVER REB CHARDLE SHATZLABAM (1).png" alt="Star of David"></center>
                <div>
                   <center> <strong>kusher reb chardle<br>kusher agency</strong></center>
                    <p>krcka.rebchardle.org<br>info@rebchardle.org<br>(617) 506-978</p>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="header-hebrew" id="certificateDate">
                <!-- Date will be filled by JavaScript -->
            </div>
            <div class="title">
                Kosher Certificate
            </div>
            <div class="certify-text">
                This is to certify that<br><br>
                <span class="establishment" id="establishmentName">Establishment Name</span><br><br>
                is under our Supervision and is a certified establishment classified as:
            </div>
            <div class="classification" id="kosherClassification">
                Kosher Status
            </div>
            <div class="validity">
                Valid: March 13, 2025 ~ April 11, 2026
            </div>
            <div class="notes">
                Certification does NOT include Passover<br>
                Delivered items certified Kosher only if Kosher tape / seal is intact
            </div>
            <div class="signature">
                <div class="signature-name">Reb Chardle</div>
                <div>Kashrus Administrator</div>
            </div>
            <div class="footer-right">
                This certificate is the property of the<br>
                Kusher Reb Chardle Kusher Agency<br>
                and may be recalled at any time<br>
                For retail display only.
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <!-- Modal for Downloading Message -->
    <div id="downloadingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center; text-align: center; color: white; font-size: 20px; font-family: Arial, sans-serif;">
        <div style="background-color: #1f2c4d; padding: 25px 40px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            <p>Generating Certificate PDF...</p>
            <p style="font-size: 16px;">Your download will begin shortly.</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>

    <!-- PDF Generation Libraries -->
    <!-- html2canvas for rendering HTML element to canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for creating PDF document -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // TODO: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg",
      authDomain: "richardrccr-10a9d.firebaseapp.com",
      projectId: "richardrccr-10a9d",
      storageBucket: "richardrccr-10a9d.firebasestorage.app",
      messagingSenderId: "867270362103",
      appId: "1:867270362103:web:7653459445810350b864f2"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        function generateAndDownloadPDF(establishmentName) {
            const certificateElement = document.querySelector('.certificate');
            const modalElement = document.getElementById('downloadingModal');

            if (!certificateElement) {
                console.error('Certificate element not found for PDF generation!');
                if (modalElement) modalElement.style.display = 'none'; // Hide modal if error before start
                return;
            }

            if (modalElement) {
                modalElement.style.display = 'flex'; // Show modal (use flex for centering its content)
            } else {
                console.warn('Downloading modal element not found. Proceeding without it.');
            }

            console.log('Starting PDF generation for:', establishmentName);

            html2canvas(certificateElement, {
                scale: 2, // Increase scale for better resolution in PDF
                useCORS: true, // Important if images are from other domains (though local here)
                logging: true // Enable logging for debugging html2canvas
            }).then(canvas => {
                console.log('Canvas created, width:', canvas.width, 'height:', canvas.height);
                const imgData = canvas.toDataURL('image/png');
                
                // Use window.jspdf.jsPDF as jsPDF is loaded as a UMD module
                const pdf = new window.jspdf.jsPDF({
                    orientation: canvas.width > canvas.height ? 'l' : 'p', // landscape or portrait
                    unit: 'pt', // points
                    format: [canvas.width, canvas.height] // set pdf page size to canvas size
                });

                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                const safeEstablishmentName = establishmentName ? establishmentName.replace(/[^a-z0-9_]+/gi, '_').toLowerCase() : 'kosher_certificate';
                const fileName = `${safeEstablishmentName}_certificate.pdf`;
                pdf.save(fileName);
                console.log('PDF saved as:', fileName);

                // Attempt to close the window after a short delay
                setTimeout(() => {
                    window.close();
                }, 500); // 500ms delay, adjust if needed
            }).catch(err => {
                console.error('Error generating PDF:', err);
                if (modalElement) modalElement.style.display = 'none'; // Hide modal on error
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const establishmentId = urlParams.get('id');

            const establishmentNameEl = document.getElementById('establishmentName');
            const kosherClassificationEl = document.getElementById('kosherClassification');
            const certificateDateEl = document.getElementById('certificateDate');
            let pdfFileName = 'kosher_certificate'; // Default PDF filename

            // Set the current date
            const currentDate = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric' };
            certificateDateEl.textContent = currentDate.toLocaleDateString('en-US', dateOptions);
            // If you want to add a Hebrew date here as well, you'd need a library or custom function
            // to generate it. For now, it will just be the Gregorian date.

            if (establishmentId) {
                db.collection('establishments').doc(establishmentId).get()
                    .then(doc => {
                        let establishmentDataForPdf;
                        if (doc.exists) {
                            const establishment = doc.data();
                            establishmentDataForPdf = establishment; // Store for PDF naming
                            establishmentNameEl.textContent = establishment.name;
                            kosherClassificationEl.innerHTML = establishment.kosherStatus;
                            pdfFileName = establishment.name;
                        } else {
                            console.error("No such document for ID:", establishmentId);
                            establishmentNameEl.textContent = "Establishment not found";
                            kosherClassificationEl.textContent = "-";
                            pdfFileName = "establishment_not_found";
                        }
                        // Generate PDF after DOM is updated
                        generateAndDownloadPDF(pdfFileName);
                    })
                    .catch(error => {
                        console.error("Error getting document:", error);
                        establishmentNameEl.textContent = "Error loading data";
                        kosherClassificationEl.textContent = "-"; // Ensure this is set on error
                        pdfFileName = "error_loading_data";
                        // Generate PDF of the error state
                        generateAndDownloadPDF(pdfFileName);
                    });
            } else {
                console.error("No establishment ID provided in URL.");
                establishmentNameEl.textContent = "No ID provided";
                kosherClassificationEl.textContent = "-";
                pdfFileName = "no_id_provided";
                // Generate PDF of the "no ID" state
                generateAndDownloadPDF(pdfFileName);
            }
        });
    </script>
</body>
</html>