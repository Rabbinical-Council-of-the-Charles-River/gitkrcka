<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Payroll</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #f8f9fa;
        }
        .hidden { display: none !important; }
        .table-wrapper {
            background: #fff;
            padding: 20px 25px;
            margin: 30px auto;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,.05);
            max-width: 1100px;
        }
        .table-title h2 { margin: 5px 0 0; font-size: 24px; }
        .table-title .btn { float: right; height: 34px; font-size: 14px; }
        .modal-body .form-label { font-weight: bold; }
        .action-icons a { margin: 0 5px; cursor: pointer; }
        /* Added style for visibility icon */
        .action-icons a .material-icons { vertical-align: middle; }
        .status-draft { background-color: #6c757d; color: white; }
        .status-processed { background-color: #ffc107; color: black; } /* Yellow for processed by payroll admin */
        .status-processing_bank { background-color: #0dcaf0; color: black; } /* Light blue for sent to bank */
        .status-paid { background-color: #198754; color: white; } /* Green for fully paid */
        .badge { padding: 0.4em 0.6em; font-size: 0.8em; }
        .deduction-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .deduction-item input { flex-grow: 1; }
        .deduction-item button { flex-shrink: 0; }
        #payroll-items-table td:last-child, #payrolls-table td:last-child { white-space: nowrap; }
    </style>
</head>

<body>
    <!-- Login Section -->
    <div id="login-section">
        <div class="container" style="max-width: 400px; margin: 50px auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
            <h1 class="text-center">Admin Access Required</h1>
            <div class="d-grid gap-2 mt-4">
                <button id="netlify-login-button" class="btn btn-primary btn-lg">Login with Netlify Identity</button>
            </div>
        </div>
    </div>

    <!-- Admin Content -->
    <div id="admin-content" class="hidden">
        <div class="container-fluid">
            <div class="table-wrapper">
                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-6">
                            <h2>Manage <b>Payroll Runs</b></h2>
                       
                        </div>
                        <div class="col-sm-6 text-end">
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#payrollRunModal" onclick="prepareAddPayrollRun()">
                                <i class="material-icons">&#xE147;</i> <span>Create New Payroll Run</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive mt-3">
                    <table id="payrolls-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Pay Period</th>
                                <th>Issue Date</th>
                                <th>Status</th>
                                <th>Total Net Pay</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Payroll runs loaded here -->
                            <tr><td colspan="5">Loading payroll runs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Payroll Run Modal (Add/Edit) -->
        <div id="payrollRunModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="payroll-run-form">
                        <div class="modal-header">
                            <h5 class="modal-title" id="payrollRunModalTitle">Create Payroll Run</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="payroll-run-id">
                            <div class="mb-3">
                                <label for="pay-period-start" class="form-label">Pay Period Start</label>
                                <input type="date" id="pay-period-start" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="pay-period-end" class="form-label">Pay Period End</label>
                                <input type="date" id="pay-period-end" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="issue-date" class="form-label">Issue Date (Planned)</label>
                                <input type="date" id="issue-date" class="form-control" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Payroll Run</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Payroll Run Status Modal -->
        <div id="editPayrollRunStatusModal" class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <form id="edit-payroll-run-status-form">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Payroll Run Status</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="edit-status-payroll-run-id">
                            <label for="payroll-run-new-status" class="form-label">New Status</label>
                            <select id="payroll-run-new-status" class="form-select" required></select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Status</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Manage Payroll Items Modal -->
        <div id="manageItemsModal" class="modal fade" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-xl"> <!-- Extra Large -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Manage Items for Payroll: <span id="manage-items-title"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="manage-items-payroll-id">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                             <button class="btn btn-success" onclick="prepareAddPayrollItem()">
                                <i class="material-icons">&#xE147;</i> <span>Add Employee Payment</span>
                            </button>
                            <div>
                                <strong>Status:</strong> <span id="manage-items-status-badge" class="badge"></span>
                                <button id="process-payroll-btn" class="btn btn-primary btn-sm ms-2" onclick="processPayrollRun()">
                                    <i class="material-icons">play_arrow</i> Process & Send to Bank
                                </button>
                            </div>
                        </div>

                        <!-- Placeholder for processing message -->
                        <div id="processing-message-area" class="alert alert-info hidden mt-3" role="alert"></div>

                        <div class="table-responsive">
                            <table id="payroll-items-table" class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>Employee Email</th>
                                        <th>Name</th>
                                        <th>Gross Pay</th>
                                        <th>Net Pay</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Items loaded here -->
                                </tbody>
                            </table>
                        </div>
                         <div class="text-end mt-2">
                            <strong>Total Net Pay for this Run: <span id="manage-items-total-net"></span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payroll Item Modal (Add/Edit Employee Payment) -->
        <div id="payrollItemModal" class="modal fade" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="payroll-item-form">
                        <div class="modal-header">
                            <h5 class="modal-title" id="payrollItemModalTitle">Add Employee Payment</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="payroll-item-id">
                            <input type="hidden" id="payroll-item-parent-id"> <!-- Hidden field for parent payroll ID -->

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="employee-email" class="form-label">Employee Email</label>
                                    <input type="email" id="employee-email" class="form-control" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="employee-name" class="form-label">Employee Name</label> <!-- Made name required for log import -->
                                    <input type="text" id="employee-name" class="form-control" required>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                     <label for="pay-rate" class="form-label">Pay Rate (e.g., hourly or fixed)</label>
                                     <input type="number" id="pay-rate" class="form-control" step="0.01" min="0" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="hours-worked" class="form-label">Hours Worked / Quantity</label>
                                    <div class="input-group">
                                        <input type="number" id="hours-worked" class="form-control" step="0.01" min="0" required>
                                        <!-- Removed Import Button - Assuming manual entry or future different implementation -->
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Gross Earnings</label>
                                    <input type="text" id="gross-earnings" class="form-control" readonly>
                                </div>
                            </div>

                            <hr>
                            <h6>Deductions</h6>
                            <div id="deductions-container">
                                <!-- Deduction items added here -->
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addDeductionRow()">Add Deduction</button>

                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Total Deductions</label>
                                    <input type="text" id="total-deductions" class="form-control" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Net Pay</label>
                                    <input type="text" id="net-pay" class="form-control" readonly>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="item-notes" class="form-label">Notes (Optional)</label>
                                <textarea id="item-notes" class="form-control" rows="2"></textarea>
                            </div>

                             <div class="mb-3">
                                <label for="item-status" class="form-label">Payment Status</label>
                                <select id="item-status" class="form-select">
                                    <option value="pending">Pending</option>
                                    <option value="processed">Processed (Internal)</option>
                                    <option value="paid">Paid (by Bank)</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Payment Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div> <!-- End Admin Content -->

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <!-- Netlify Identity Widget -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
        // --- Firebase Configuration ---
        // IMPORTANT: Replace with YOUR PAYROLL SYSTEM'S Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg",
            authDomain: "richardrccr-10a9d.firebaseapp.com",
            projectId: "richardrccr-10a9d",
            storageBucket: "richardrccr-10a9d.firebasestorage.app",
            messagingSenderId: "867270362103",
            appId: "1:867270362103:web:7653459445810350b864f2"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();
        const payrollsRef = db.collection('payrolls');
        const payrollItemsRef = db.collection('payrollItems');
        const logsRef = db.collection('mashgiach-logs'); // Assuming this is your logs collection

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');
        const netlifyLoginButton = document.getElementById('netlify-login-button');
        const payrollsTableBody = document.querySelector('#payrolls-table tbody');
        const payrollItemsTableBody = document.querySelector('#payroll-items-table tbody');
        const payrollRunForm = document.getElementById('payroll-run-form');
        const payrollItemForm = document.getElementById('payroll-item-form');
        const payrollRunModalEl = document.getElementById('payrollRunModal');
        const manageItemsModalEl = document.getElementById('manageItemsModal');
        const payrollItemModalEl = document.getElementById('payrollItemModal');
        const editPayrollRunStatusModalEl = document.getElementById('editPayrollRunStatusModal');
        const deductionsContainer = document.getElementById('deductions-container');

        // Modals Instances
        const payrollRunModal = new bootstrap.Modal(payrollRunModalEl);
        const manageItemsModal = new bootstrap.Modal(manageItemsModalEl);
        const payrollItemModal = new bootstrap.Modal(payrollItemModalEl);
        const editPayrollRunStatusModal = new bootstrap.Modal(editPayrollRunStatusModalEl);

        // --- Netlify Identity ---
        const netlifyIdentity = window.netlifyIdentity;
        netlifyIdentity.init();

        netlifyLoginButton.addEventListener('click', () => netlifyIdentity.open());

        netlifyIdentity.on('init', user => handleAuthChange(user));
        netlifyIdentity.on('login', user => { handleAuthChange(user); netlifyIdentity.close(); });
        netlifyIdentity.on('logout', () => handleAuthChange(null));

        function handleAuthChange(user) {
            const hasPayrollRole = user?.app_metadata?.roles?.includes('payroll') ?? false;
            if (hasPayrollRole) {
                loginSection.classList.add('hidden');
                adminContent.classList.remove('hidden');
                loadPayrollRuns();
            } else {
                loginSection.classList.remove('hidden');
                adminContent.classList.add('hidden');
                if (payrollsTableBody) payrollsTableBody.innerHTML = '<tr><td colspan="5">Payroll access required.</td></tr>';
            }
        }

        // --- Helper Functions ---
        function formatTimestamp(timestamp, format = 'date') {
            if (!timestamp || typeof timestamp.toDate !== 'function') return 'N/A';
            const date = timestamp.toDate();
            if (format === 'date') {
                return date.toLocaleDateString('en-CA'); // YYYY-MM-DD
            } else if (format === 'datetime') {
                return date.toLocaleString();
            }
            return 'Invalid Format';
        }

        const PAYROLL_RUN_STATUSES = {
            draft: 'Draft',
            processed: 'Processed (Internal)',
            processing_bank: 'Sent to Bank',
            paid: 'Paid'
        };

        function formatCurrency(amount) {
            return '$' + (amount != null ? Number(amount).toFixed(2) : '0.00');
        }

        function getStatusBadge(status) {
            const statusLower = (status || 'draft').toLowerCase();
            let badgeClass = `status-${statusLower}`;
            // Handle specific status text for display if needed
            let statusText = statusLower.charAt(0).toUpperCase() + statusLower.slice(1);
            if (statusLower === 'processing_bank') {
                statusText = PAYROLL_RUN_STATUSES.processing_bank;
            }

            return `<span class="badge ${badgeClass}">${statusText}</span>`;
        }

        function parseDateToTimestamp(dateString) {
            if (!dateString) return null;
            const date = new Date(dateString + 'T00:00:00Z');
            return firebase.firestore.Timestamp.fromDate(date);
        }

        // --- Payroll Run Functions ---
        async function loadPayrollRuns() {
            payrollsTableBody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            try {
                const snapshot = await payrollsRef.orderBy('issueDate', 'desc').get();
                if (snapshot.empty) {
                    payrollsTableBody.innerHTML = '<tr><td colspan="5">No payroll runs found. Create one!</td></tr>';
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const run = doc.data();
                    const id = doc.id;
                    html += `
                        <tr data-id="${id}">
                            <td>${formatTimestamp(run.payPeriodStart)} - ${formatTimestamp(run.payPeriodEnd)}</td>
                            <td>${formatTimestamp(run.issueDate)}</td>
                            <td>${getStatusBadge(run.status)}</td>
                            <td>${formatCurrency(run.totalAmount)}</td>
                            <td class="action-icons">
                                <a onclick="openManageItemsModal('${id}')" title="Manage Items"><i class="material-icons text-primary">list</i></a>
                                <a onclick="prepareEditPayrollRun('${id}')" title="Edit Run Details"><i class="material-icons text-warning">&#xE254;</i></a>
                                <a onclick="prepareEditPayrollRunStatus('${id}')" title="Edit Status"><i class="material-icons text-secondary">flag</i></a>
                                <a onclick="deletePayrollRun('${id}')" title="Delete Run"><i class="material-icons text-danger">&#xE872;</i></a>
                            </td>
                        </tr>
                    `;
                });
                payrollsTableBody.innerHTML = html;
            } catch (error) {
                console.error("Error loading payroll runs:", error);
                payrollsTableBody.innerHTML = '<tr><td colspan="5" class="text-danger">Error loading payroll runs.</td></tr>';
            }
        }

        function prepareAddPayrollRun() {
            payrollRunForm.reset();
            document.getElementById('payroll-run-id').value = '';
            document.getElementById('payrollRunModalTitle').textContent = 'Create New Payroll Run';
            payrollRunModal.show();
        }

        async function prepareEditPayrollRun(id) {
            payrollRunForm.reset();
            try {
                const docSnap = await payrollsRef.doc(id).get();
                if (docSnap.exists) {
                    const run = docSnap.data();
                    document.getElementById('payroll-run-id').value = id;
                    document.getElementById('pay-period-start').value = formatTimestamp(run.payPeriodStart);
                    document.getElementById('pay-period-end').value = formatTimestamp(run.payPeriodEnd);
                    document.getElementById('issue-date').value = formatTimestamp(run.issueDate);
                    document.getElementById('payrollRunModalTitle').textContent = 'Edit Payroll Run';
                    payrollRunModal.show();
                } else {
                    alert("Payroll run not found.");
                }
            } catch (error) {
                console.error("Error preparing edit:", error);
                alert("Error loading payroll run details.");
            }
        }

        payrollRunForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('payroll-run-id').value;
            const runData = {
                payPeriodStart: parseDateToTimestamp(document.getElementById('pay-period-start').value),
                payPeriodEnd: parseDateToTimestamp(document.getElementById('pay-period-end').value),
                issueDate: parseDateToTimestamp(document.getElementById('issue-date').value),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (id) { // Editing existing
                    await payrollsRef.doc(id).update(runData);
                } else { // Creating new
                    runData.status = 'draft';
                    runData.totalAmount = 0;
                    runData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    runData.createdBy = netlifyIdentity.currentUser()?.id || 'unknown';
                    await payrollsRef.add(runData);
                }
                payrollRunModal.hide();
                loadPayrollRuns();
            } catch (error) {
                console.error("Error saving payroll run:", error);
                alert(`Error saving payroll run: ${error.message}`);
            }
        });

        function populateStatusDropdown(selectElementId, currentStatus) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = ''; // Clear existing options
            for (const [value, text] of Object.entries(PAYROLL_RUN_STATUSES)) {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (value === currentStatus) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        async function prepareEditPayrollRunStatus(id) {
            try {
                const docSnap = await payrollsRef.doc(id).get();
                if (docSnap.exists) {
                    const run = docSnap.data();
                    document.getElementById('edit-status-payroll-run-id').value = id;
                    populateStatusDropdown('payroll-run-new-status', run.status || 'draft');
                    editPayrollRunStatusModal.show();
                } else {
                    alert("Payroll run not found.");
                }
            } catch (error) {
                console.error("Error preparing status edit:", error);
                alert("Error loading payroll run details for status edit.");
            }
        }

        document.getElementById('edit-payroll-run-status-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-status-payroll-run-id').value;
            const newStatus = document.getElementById('payroll-run-new-status').value;

            if (!id || !newStatus) {
                alert("Missing payroll run ID or new status.");
                return;
            }
            try {
                await payrollsRef.doc(id).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                editPayrollRunStatusModal.hide();
                loadPayrollRuns(); // Refresh the main table
            } catch (error) {
                console.error("Error updating payroll run status:", error);
                alert(`Error updating status: ${error.message}`);
            }
        });

        async function deletePayrollRun(id) {
            if (!confirm("Are you sure you want to delete this entire payroll run and all its items? This cannot be undone.")) {
                return;
            }
            try {
                const itemsSnapshot = await payrollItemsRef.where('payrollId', '==', id).get();
                const batch = db.batch();
                itemsSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await payrollsRef.doc(id).delete();
                loadPayrollRuns();
            } catch (error) {
                console.error("Error deleting payroll run:", error);
                alert(`Error deleting payroll run: ${error.message}`);
            }
        }

        async function processPayrollRun(payrollIdFromButton) {
             const payrollId = payrollIdFromButton || document.getElementById('manage-items-payroll-id').value;
             if (!payrollId) {
                 alert("Cannot process payroll: No Payroll ID found.");
                 return;
             }

             try {
                 const itemsSnapshot = await payrollItemsRef
                                             .where('payrollId', '==', payrollId)
                                             // Consider filtering for items in 'pending' or 'processed (internal)' status
                                             // .where('paymentStatus', 'in', ['pending', 'processed'])
                                             .get();

                 if (itemsSnapshot.empty) {
                     alert("No payment items found for this payroll run to process.");
                     return;
                 }

                 const payments = [];
                 itemsSnapshot.forEach(doc => {
                     const item = doc.data();
                     // Ensure item has email, name, and positive net pay
                     if (item.employeeEmail && item.employeeName && item.netPay > 0) {
                         payments.push({
                             email: item.employeeEmail,
                             name: item.employeeName, // Include name for bank site if needed
                             amount: item.netPay.toFixed(2)
                         });
                     }
                 });

                 if (payments.length === 0) {
                     alert("No valid payment items (with email, name, and positive net pay) found to process.");
                     return;
                 }

                 // IMPORTANT: Replace with the ACTUAL URL of your BOOPKA banking site's payroll deposit page
                 const bankingBaseUrl = 'https://boopka.netlify.app/payroll_deposit.html';
                 // For local testing, it might be like: 'http://127.0.0.1:5500/boopka/payroll_deposit.html'
                 // or whatever your local server for the BOOPKA project uses.

                 const params = new URLSearchParams();
                 params.append('payrollData', JSON.stringify(payments));
                 params.append('payrollRunId', payrollId);

                 const bankingUrl = `${bankingBaseUrl}?${params.toString()}`;

                 // Update the status of the payroll run in THIS payroll system
                 await payrollsRef.doc(payrollId).update({
                     status: 'processing_bank', // Indicates data sent to bank
                     processedAt: firebase.firestore.FieldValue.serverTimestamp()
                 });

                 console.log(`Payroll run ${payrollId} data sent to banking site. URL: ${bankingUrl}`);

                // Display success message with link instead of alert and window.open
                const messageArea = document.getElementById('processing-message-area');
                messageArea.innerHTML = `Payroll data prepared. <a href="${bankingUrl}" target="_blank" class="alert-link">Click here to proceed to the banking site</a> to complete deposits. The site will open in a new tab.`;
                messageArea.classList.remove('hidden');
                // Disable the process button after successful initiation
                document.getElementById('process-payroll-btn').disabled = true;

                 // Refresh UI elements
                 const runDoc = await payrollsRef.doc(payrollId).get();
                 if (runDoc.exists) {
                     updateManageItemsUI(runDoc.data(), payrollId);
                 }
                 loadPayrollRuns();
                 loadPayrollItems(payrollId);

             } catch (error) {
                 console.error("Error preparing payroll data for banking site:", error);
                 alert(`Error preparing payroll data: ${error.message}`);
             }
        }

        // --- Manage Payroll Items Modal ---
        async function openManageItemsModal(payrollId) {
            document.getElementById('manage-items-payroll-id').value = payrollId;
            payrollItemsTableBody.innerHTML = '<tr><td colspan="6">Loading items...</td></tr>';
            document.getElementById('manage-items-total-net').textContent = formatCurrency(0);
            document.getElementById('processing-message-area').classList.add('hidden'); // Clear previous messages
            document.getElementById('processing-message-area').innerHTML = '';

            try {
                const runDoc = await payrollsRef.doc(payrollId).get();
                if (runDoc.exists) {
                    const runData = runDoc.data();
                    updateManageItemsUI(runData, payrollId);
                    loadPayrollItems(payrollId);
                    manageItemsModal.show();
                } else {
                    alert("Payroll run not found.");
                }
            } catch (error) {
                console.error("Error opening manage items modal:", error);
                alert("Error loading payroll run details.");
            }
        }

        function updateManageItemsUI(runData, payrollId) {
             document.getElementById('manage-items-title').textContent =
                `${formatTimestamp(runData.payPeriodStart)} - ${formatTimestamp(runData.payPeriodEnd)}`;

             const statusBadgeElement = document.getElementById('manage-items-status-badge');
             if (statusBadgeElement) {
                 statusBadgeElement.outerHTML = getStatusBadge(runData.status);
             }

            const processBtn = document.getElementById('process-payroll-btn');
            if (processBtn) {
                // Allow processing if status is 'draft' or 'processed' (internal)
                // Disable if 'processing_bank' or 'paid'
                if (runData.status === 'draft' || runData.status === 'processed') {
                    processBtn.disabled = false;
                    processBtn.onclick = () => processPayrollRun(payrollId);
                } else {
                    processBtn.disabled = true;
                    processBtn.onclick = null;
                }
            }
        }

        async function loadPayrollItems(payrollId) {
            payrollItemsTableBody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
            let totalNetPay = 0;
            try {
                const snapshot = await payrollItemsRef.where('payrollId', '==', payrollId).get();
                if (snapshot.empty) {
                    payrollItemsTableBody.innerHTML = '<tr><td colspan="6">No payment items added yet.</td></tr>';
                     document.getElementById('manage-items-total-net').textContent = formatCurrency(0);
                    return;
                }
                let html = '';
                snapshot.forEach(doc => {
                    const item = doc.data();
                    const id = doc.id;
                    totalNetPay += Number(item.netPay) || 0;
                    html += `
                        <tr data-id="${id}">
                            <td>${item.employeeEmail || 'N/A'}</td>
                            <td>${item.employeeName || ''}</td>
                            <td>${formatCurrency(item.grossEarnings)}</td>
                            <td>${formatCurrency(item.netPay)}</td>
                            <td>${getStatusBadge(item.paymentStatus)}</td>
                            <td class="action-icons">
                                <a onclick="viewPayStubAdmin('${id}')" title="View Stub"><i class="material-icons text-info">visibility</i></a>
                                <a onclick="prepareEditPayrollItem('${id}')" title="Edit Item"><i class="material-icons text-warning">&#xE254;</i></a>
                                <a onclick="deletePayrollItem('${id}', '${payrollId}')" title="Delete Item"><i class="material-icons text-danger">&#xE872;</i></a>
                            </td>
                        </tr>
                    `;
                });
                payrollItemsTableBody.innerHTML = html;
                document.getElementById('manage-items-total-net').textContent = formatCurrency(totalNetPay);
            } catch (error) {
                console.error("Error loading payroll items:", error);
                payrollItemsTableBody.innerHTML = '<tr><td colspan="6" class="text-danger">Error loading items.</td></tr>';
                 document.getElementById('manage-items-total-net').textContent = formatCurrency(0);
            }
        }

        // --- Payroll Item Functions (Add/Edit Employee Payment) ---
        function prepareAddPayrollItem() {
            payrollItemForm.reset();
            document.getElementById('payroll-item-id').value = '';
            document.getElementById('payrollItemModalTitle').textContent = 'Add Employee Payment';
            document.getElementById('payroll-item-parent-id').value = document.getElementById('manage-items-payroll-id').value;
            deductionsContainer.innerHTML = '';
            addDeductionRow();
            calculateItemTotals();
            document.getElementById('item-status').value = 'pending';
            payrollItemModal.show();
        }

        async function prepareEditPayrollItem(itemId) {
            payrollItemForm.reset();
            deductionsContainer.innerHTML = '';
            try {
                const docSnap = await payrollItemsRef.doc(itemId).get();
                if (docSnap.exists) {
                    const item = docSnap.data();
                    document.getElementById('payroll-item-id').value = itemId;
                    document.getElementById('payroll-item-parent-id').value = item.payrollId;
                    document.getElementById('employee-email').value = item.employeeEmail || '';
                    document.getElementById('employee-name').value = item.employeeName || '';
                    document.getElementById('pay-rate').value = item.payRate || 0;
                    document.getElementById('hours-worked').value = item.hoursWorked || 0;
                    document.getElementById('item-notes').value = item.notes || '';
                    document.getElementById('item-status').value = item.paymentStatus || 'pending';

                    if (item.deductions && Array.isArray(item.deductions)) {
                        item.deductions.forEach(ded => addDeductionRow(ded.description, ded.amount));
                    } else {
                        addDeductionRow();
                    }

                    calculateItemTotals();
                    document.getElementById('payrollItemModalTitle').textContent = 'Edit Employee Payment';
                    payrollItemModal.show();
                } else {
                    alert("Payroll item not found.");
                }
            } catch (error) {
                console.error("Error preparing item edit:", error);
                alert("Error loading item details.");
            }
        }

        payrollItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('payroll-item-id').value;
            const parentPayrollId = document.getElementById('payroll-item-parent-id').value;

            if (!parentPayrollId) {
                alert("Error: Parent Payroll ID is missing.");
                return;
            }

            const totals = calculateItemTotals();
            const deductions = [];
            deductionsContainer.querySelectorAll('.deduction-item').forEach(row => {
                const desc = row.querySelector('.deduction-desc').value.trim();
                const amount = parseFloat(row.querySelector('.deduction-amount').value) || 0;
                if (desc && amount > 0) {
                    deductions.push({ description: desc, amount: amount });
                }
            });

            let parentIssueDate = null, parentStartDate = null, parentEndDate = null;
            try {
                const parentDoc = await payrollsRef.doc(parentPayrollId).get();
                if (parentDoc.exists) {
                    const parentData = parentDoc.data();
                    parentIssueDate = parentData.issueDate || null;
                    parentStartDate = parentData.payPeriodStart || null;
                    parentEndDate = parentData.payPeriodEnd || null;
                }
            } catch (fetchError) { console.error("Error fetching parent payroll dates:", fetchError); }

            const itemData = {
                payrollId: parentPayrollId,
                employeeEmail: document.getElementById('employee-email').value.trim(),
                employeeName: document.getElementById('employee-name').value.trim(),
                payRate: parseFloat(document.getElementById('pay-rate').value) || 0,
                hoursWorked: parseFloat(document.getElementById('hours-worked').value) || 0,
                grossEarnings: totals.gross,
                deductions: deductions,
                netPay: totals.net,
                notes: document.getElementById('item-notes').value.trim(),
                paymentStatus: document.getElementById('item-status').value,
                importedLogIds: itemId ? (await payrollItemsRef.doc(itemId).get()).data()?.importedLogIds || [] : [],
                issueDate: parentIssueDate,
                payPeriodStart: parentStartDate,
                payPeriodEnd: parentEndDate,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if (itemId) {
                    await payrollItemsRef.doc(itemId).update(itemData);
                } else {
                    itemData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await payrollItemsRef.add(itemData);
                }
                payrollItemModal.hide();
                loadPayrollItems(parentPayrollId);
                updatePayrollRunTotal(parentPayrollId);
            } catch (error) {
                console.error("Error saving payroll item:", error);
                alert(`Error saving item: ${error.message}`);
            }
        });

        async function deletePayrollItem(itemId, parentPayrollId) {
            if (!confirm("Are you sure you want to delete this payment item?")) return;
            try {
                await payrollItemsRef.doc(itemId).delete();
                loadPayrollItems(parentPayrollId);
                updatePayrollRunTotal(parentPayrollId);
            } catch (error) {
                console.error("Error deleting item:", error);
                alert(`Error deleting item: ${error.message}`);
            }
        }

        // --- Calculations & Deductions ---
        function calculateItemTotals() {
            const rate = parseFloat(document.getElementById('pay-rate').value) || 0;
            const hours = parseFloat(document.getElementById('hours-worked').value) || 0;
            const gross = rate * hours;

            let totalDeductions = 0;
            deductionsContainer.querySelectorAll('.deduction-item .deduction-amount').forEach(input => {
                totalDeductions += parseFloat(input.value) || 0;
            });

            const net = gross - totalDeductions;

            document.getElementById('gross-earnings').value = formatCurrency(gross);
            document.getElementById('total-deductions').value = formatCurrency(totalDeductions);
            document.getElementById('net-pay').value = formatCurrency(net);

            return { gross, totalDeductions, net };
        }

        ['pay-rate', 'hours-worked'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', calculateItemTotals);
        });

        function addDeductionRow(description = '', amount = '') {
            const row = document.createElement('div');
            row.classList.add('deduction-item');
            row.innerHTML = `
                <input type="text" class="form-control form-control-sm deduction-desc" placeholder="Deduction Description" value="${description}">
                <input type="number" class="form-control form-control-sm deduction-amount" placeholder="Amount" value="${amount}" step="0.01" min="0">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDeductionRow(this)">&times;</button>
            `;
            row.querySelector('.deduction-amount').addEventListener('input', calculateItemTotals);
            deductionsContainer.appendChild(row);
        }

        function removeDeductionRow(button) {
            button.closest('.deduction-item').remove();
            calculateItemTotals();
        }

         async function updatePayrollRunTotal(payrollId) {
             if (!payrollId) return;
             try {
                 const itemsSnapshot = await payrollItemsRef.where('payrollId', '==', payrollId).get();
                 let totalNetPay = 0;
                 itemsSnapshot.forEach(doc => {
                     totalNetPay += Number(doc.data().netPay) || 0;
                 });

                 await payrollsRef.doc(payrollId).update({ totalAmount: totalNetPay });
                 if (manageItemsModalEl.classList.contains('show') && document.getElementById('manage-items-payroll-id').value === payrollId) {
                     document.getElementById('manage-items-total-net').textContent = formatCurrency(totalNetPay);
                 }
             } catch (error) {
                 console.error("Error updating payroll run total:", error);
             }
         }

        function viewPayStubAdmin(itemId) {
            if (!itemId) {
                console.error("No item ID provided for viewing stub.");
                return;
            }
            // Ensure the path to payroll-stub.html is correct relative to this admin page
            const stubUrl = `payroll-stub.html?id=${itemId}`;
            window.open(stubUrl, '_blank');
        }

        // --- Modal Cleanup ---
        [payrollItemModalEl, payrollRunModalEl, editPayrollRunStatusModalEl].forEach(modalEl => {
            if (modalEl) {
                modalEl.addEventListener('hidden.bs.modal', () => {
                    const form = modalEl.querySelector('form');
                    if (form) form.reset();
                    if (modalEl === payrollItemModalEl) deductionsContainer.innerHTML = '';
                    if (modalEl === editPayrollRunStatusModalEl) {
                        document.getElementById('edit-status-payroll-run-id').value = '';
                    }
                });
            }
        });

         manageItemsModalEl.addEventListener('hidden.bs.modal', () => {
            loadPayrollRuns();
        });
    </script>

</body>
</html>