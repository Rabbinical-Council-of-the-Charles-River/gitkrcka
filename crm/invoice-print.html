<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>KRCKA Invoice</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body {
            background-color: #f8f9fa; /* Light grey background for the overall page */
            font-family: 'Times New Roman', Times, serif; /* Formal serif font */
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            max-width: 8.5in; /* Sized for Letter paper width */
            width: 100%;
            margin: 30px auto;
            background: #fff; /* White background */
            box-shadow: 0 0 15px rgba(0,0,0,.1);
            border-radius: 0;
            padding: 0.75in; /* Padding to act as page margins */
            box-sizing: border-box;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 11px;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: white !important;
            }
            .container {
                max-width: none;
                width: auto;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
            }
            .no-print { display: none !important; }
        }

        /* Invoice styles to match the image */
        .invoice-content {
            padding: 0;
            margin: 0;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }
        .invoice-header-left {
            flex-grow: 1;
        }
        .company-info h2 {
            font-size: 2.25rem; /* Increased font size for company name */
            margin-bottom: 0.25rem;
            font-weight: normal;
        }
        .company-info p {
            font-size: 12px;
            line-height: 1.2;
            margin-bottom: 0;
        }
        .invoice-header-right {
            flex-shrink: 0;
            margin-left: 20px;
            text-align: right;
        }
        .invoice-details-box {
            border: 1px solid #000;
            padding: 5px 10px;
            margin-top: 5px;
            width: 250px;
            display: inline-block;
        }
        .invoice-details-box p {
            margin-bottom: 0;
            font-size: 13px;
        }
        .invoice-details-box p strong {
            display: inline-block;
            width: 70px;
        }

        .bill-to-box, .comments-box {
            border: 1px solid #000;
            background-color: #35478c; /* Dark blue background */
            color: white;
            padding: 5px;
            font-size: 14px;
            font-weight: bold;
        }
        .bill-to-section {
            border: 1px solid #000;
            padding: 10px;
            min-height: 120px;
            border-top: none;
        }
        .bill-to-section p {
            font-size: 12px;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        
        /* New container for the main body */
        .invoice-main-body-box {
            border: 1px solid #000;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            margin-bottom: 0;
        }
        .invoice-table thead {
            background-color: #35478c;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }
        .invoice-table th, .invoice-table td {
            padding: 8px;
            border: none;
            vertical-align: top;
        }
        .invoice-table th {
            text-align: left;
        }
        .invoice-table tbody td {
            font-size: 13px;
            border-bottom: 1px solid #ddd;
        }
        .invoice-table tbody tr:last-child td {
            border-bottom: none;
        }
        .invoice-table .description-column {
            width: 50%;
        }
        .invoice-table .taxed-column {
            width: 15%;
            text-align: center;
        }
        .invoice-table .amount-column {
            width: 35%;
            text-align: right;
        }

        .totals-section {
            border: 1px solid #000;
            border-top: none;
            padding: 10px;
        }
        .totals-table {
            width: 100%;
        }
        .totals-table td {
            padding: 2px 5px;
            font-size: 14px;
        }
        .totals-table td:first-child {
            font-weight: bold;
            text-align: right;
            text-transform: uppercase;
        }
        .totals-table td:last-child {
            text-align: right;
        }
        .totals-table .total-row td {
            font-size: 16px;
            font-weight: bold;
        }
        
        .comments-section {
            margin-top: 20px;
        }
        .comments-body {
            border: 1px solid #000;
            padding: 10px;
            min-height: 100px;
            border-top: none;
            font-size: 12px;
        }

        .payment-info {
            text-align: right;
            font-size: 12px;
            margin-top: 20px;
        }
        .thank-you {
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="no-print mb-3">
            <button onclick="window.print()" class="btn btn-primary me-2">
                <i class="bi bi-printer"></i> Print Invoice
            </button>
        
            <button onclick="window.close()" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Close
            </button>
        </div>

        <div class="invoice-content" id="invoice-content-to-capture">
            <div class="invoice-header">
                <div class="invoice-header-left">
                    <div class="company-info">
                        <h2>RCCR Billing</h2>
                        <p>Mass Turnpike</p>
                        <p>Westborough MA, 01581</p>
                        <p>Phone: 617.506.9578</p>
                        <p>Email: billing@rebchardle.org</p>
                    </div>
                </div>
                <div class="invoice-header-right">
                    <h1>INVOICE</h1>
                    <div class="invoice-details-box">
                        <p><strong>DATE:</strong> <span id="invoice-date">Loading...</span></p>
                        <p><strong>INVOICE #:</strong> <span id="invoice-number">Loading...</span></p>
                        <p><strong>DUE DATE:</strong> <span id="due-date">Loading...</span></p>
                    </div>
                </div>
            </div>

            <div class="bill-to-box">BILL TO</div>
            <div class="bill-to-section" id="client-info">
                <p><strong id="client-name">Loading...</strong></p>
                <p id="client-contact">Loading...</p>
                <p id="client-email">Loading...</p>
                <p id="client-phone">Loading...</p>
                <div id="client-address">Loading...</div>
            </div>
            
            <div class="invoice-main-body-box mt-4">
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th class="description-column">DESCRIPTION</th>
                            <th class="taxed-column">TAXED</th>
                            <th class="amount-column">AMOUNT</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-end">
                <div class="totals-section mt-3">
                    <table class="totals-table">
                        <tbody>
                            <tr>
                                <td>SUBTOTAL:</td>
                                <td id="subtotal">$0.00</td>
                            </tr>
                            <tr>
                                <td>TAXABLE:</td>
                                <td id="taxable-amount">$0.00</td>
                            </tr>
                            <tr>
                                <td>TAX RATE:</td>
                                <td id="tax-rate">0.00%</td>
                            </tr>
                            <tr>
                                <td>TAX DUE:</td>
                                <td id="tax-amount">$0.00</td>
                            </tr>
                            <tr>
                                <td>OTHER:</td>
                                <td id="other-fees">$0.00</td>
                            </tr>
                            <tr class="total-row">
                                <td>TOTAL:</td>
                                <td id="total-amount">$0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row comments-section">
                <div class="col-6">
                    <div class="comments-box">OTHER COMMENTS</div>
                    <div class="comments-body">
                        <div id="comments">Please review and pay this invoice by the due date.</div>
                    </div>
                </div>
                <div class="col-6 d-flex flex-column justify-content-end">
                    <div class="payment-info">
                        Make all checks payable to <br> **Rabbinical Council of the Charles River**
                    </div>
                    <div class="thank-you">
                        Thank You For Your Business!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg",
            authDomain: "richardrccr-10a9d.firebaseapp.com",
            projectId: "richardrccr-10a9d",
            storageBucket: "richardrccr-10a9d.firebasestorage.app",
            messagingSenderId: "867270362103",
            appId: "1:867270362103:web:7653459445810350b864f2"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Utility Functions
        function formatCurrency(amount) {
            return '$' + (amount != null ? Number(amount).toFixed(2) : '0.00');
        }

        function formatDate(date) {
            if (date && typeof date.toDate === 'function') {
                return date.toDate().toLocaleDateString('en-US');
            } else if (date instanceof Date) {
                return date.toLocaleDateString('en-US');
            } else if (typeof date === 'string') {
                return new Date(date).toLocaleDateString('en-US');
            }
            return 'N/A';
        }

        // Get invoice ID from URL parameters
        function getInvoiceId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load and display invoice
        async function loadInvoice() {
            const invoiceId = getInvoiceId();
            if (!invoiceId) {
                document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">No invoice ID provided</div></div>';
                return;
            }

            try {
                const invoiceDoc = await db.collection('invoices').doc(invoiceId).get();
                if (!invoiceDoc.exists) {
                    document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">Invoice not found</div></div>';
                    return;
                }

                const invoice = invoiceDoc.data();
                let client = null;
                if (invoice.clientId) {
                    const clientDoc = await db.collection('clients').doc(invoice.clientId).get();
                    if (clientDoc.exists) {
                        client = clientDoc.data();
                    }
                }

                displayInvoice(invoice, client);

            } catch (error) {
                console.error('Error loading invoice:', error);
                document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">Error loading invoice</div></div>';
            }
        }

        function displayInvoice(invoice, client) {
            document.getElementById('invoice-number').textContent = invoice.invoiceNumber || 'N/A';
            document.getElementById('invoice-date').textContent = formatDate(invoice.issueDate);
            document.getElementById('due-date').textContent = formatDate(invoice.dueDate);
            
            if (client) {
                document.getElementById('client-name').textContent = client.companyName || 'N/A';
                document.getElementById('client-contact').textContent = client.contactPerson || '';
                document.getElementById('client-email').textContent = client.email || '';
                document.getElementById('client-phone').textContent = client.phone || '';
                document.getElementById('client-address').innerHTML = (client.address || '').replace(/\n/g, '<br>');
            } else {
                document.getElementById('client-name').textContent = invoice.clientName || 'N/A';
                document.getElementById('client-contact').textContent = '';
                document.getElementById('client-email').textContent = invoice.clientEmail || '';
                document.getElementById('client-phone').textContent = '';
                document.getElementById('client-address').textContent = '';
            }

            // Invoice items
            const itemsContainer = document.getElementById('invoice-items');
            if (invoice.items && invoice.items.length > 0) {
                itemsContainer.innerHTML = invoice.items.map(item => {
                    const total = item.quantity * item.rate;
                    return `
                        <tr>
                            <td class="description-column">${item.description}</td>
                            <td class="taxed-column">${item.taxed ? 'X' : ''}</td>
                            <td class="amount-column">${formatCurrency(total)}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                itemsContainer.innerHTML = '<tr><td colspan="3" class="text-center">No items</td></tr>';
            }
            
            // Totals
            const subtotal = (invoice.items || []).reduce((sum, item) => sum + (item.quantity * item.rate), 0);
            const taxableAmount = subtotal; // Assuming everything is taxable
            const taxAmount = taxableAmount * (invoice.taxRate || 0) / 100;
            const otherFees = invoice.otherFees || 0;
            const totalAmount = subtotal + taxAmount + otherFees;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('taxable-amount').textContent = formatCurrency(taxableAmount);
            document.getElementById('tax-rate').textContent = (invoice.taxRate || 0).toFixed(2) + '%';
            document.getElementById('tax-amount').textContent = formatCurrency(taxAmount);
            document.getElementById('other-fees').textContent = formatCurrency(otherFees);
            document.getElementById('total-amount').textContent = formatCurrency(totalAmount);
            
            document.title = `Invoice ${invoice.invoiceNumber}`;
        }

        // Function to download invoice as PDF
        async function downloadInvoicePdf() {
            const invoiceElement = document.getElementById('invoice-content-to-capture'); 
            const invoiceNumber = document.getElementById('invoice-number').textContent || 'Invoice';

            const noPrintElements = document.querySelectorAll('.no-print');
            noPrintElements.forEach(el => el.style.display = 'none');
            
            try {
                const scale = 3;
                const canvas = await html2canvas(invoiceElement, { 
                    scale: scale, 
                    useCORS: true, 
                    logging: false,
                    scrollY: -window.scrollY
                });
                const imgData = canvas.toDataURL('image/jpeg', 1.0);

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'in', 'letter');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = imgProps.width / imgProps.dpi;
                const imgHeight = imgProps.height / imgProps.dpi;

                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const finalImgWidth = imgWidth * ratio;
                const finalImgHeight = imgHeight * ratio;

                const x = (pdfWidth - finalImgWidth) / 2;
                const y = (pdfHeight - finalImgHeight) / 2;

                pdf.addImage(imgData, 'JPEG', x, y, finalImgWidth, finalImgHeight);
                pdf.save(`Invoice_${invoiceNumber}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Failed to generate PDF. This can be caused by browser security restrictions or CDN issues. Please try printing to PDF instead.');
            } finally {
                noPrintElements.forEach(el => el.style.display = '');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadInvoice();
            document.getElementById('download-pdf-btn').addEventListener('click', downloadInvoicePdf);
        });
    </script>
</body>
</html>