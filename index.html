<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRCKA Portal</title>
    <!-- Netlify Identity Widget -->
    <script src="https://cdn.jsdelivr.net/npm/netlify-identity-widget@1.9.1/build/netlify-identity-widget.min.js"></script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <style>
        body {
            font-family: 'Varela Round', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px; /* Add padding for smaller screens */
        }
        .portal-card {
            max-width: 450px;
            width: 100%;
        }
        .hidden {
            display: none !important;
        }
        .list-group-item a { text-decoration: none; color: inherit; }
        .list-group-item a:hover { text-decoration: underline; }
        .public-links a { margin-bottom: 0.5rem; }
        /* Style for login error messages */
        .login-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none; /* Hidden by default */
        }
        .login-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="card portal-card shadow-sm">
        <div class="card-body p-4 p-md-5 text-center">
            <h2 class="card-title mb-4">KRCKA Portal</h2>

            <!-- Login Form (Initially Visible) -->
            <div id="login-form-container">
                <form id="custom-login-form">
                    <div id="login-message-area" class="login-message"></div>
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="login-email" placeholder="name@example.com" required>
                        <label for="login-email">Email address</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="password" class="form-control" id="login-password" placeholder="Password" required>
                        <label for="login-password">Password</label>
                    </div>
                    <div class="d-grid mb-3">
                        <button type="submit" class="btn btn-primary btn-lg" id="login-submit-btn">Login</button>
                    </div>
                    <!-- Optional: Links for signup/password recovery -->
                    <div class="text-center">
                        <small>
                            <a href="#" onclick="netlifyIdentity.open('signup'); return false;">Sign Up</a> |
                            <a href="#" onclick="netlifyIdentity.open('requestPasswordRecovery'); return false;">Forgot Password?</a>
                        </small>
                    </div>
                </form>
            </div>

            <!-- Logged In Content (Initially Hidden) -->
            <div id="logged-in-content" class="hidden">
                <p id="user-greeting" class="lead"></p>

                <!-- Public Links -->
                <div class="d-grid gap-2 mb-4 public-links">
                    <a href="apply.html" class="btn btn-outline-secondary">Apply for Certification</a>
                    <a href="client-view.html" class="btn btn-outline-secondary">View Kosher Establishments</a>
                    <a href="alerts/alerts.html" class="btn btn-outline-warning">View Kashrus Alerts</a>
                    <a href="clients/index.html" class="btn btn-primary btn">Client Area</a>
                    <a href="payment.html" class="btn btn-outline-success">Make Payment</a>
                </div>

                <!-- Admin Links Section -->
                <div id="admin-links" class="hidden">
                    <hr>
                    <h5 class="mb-3">Admin Area</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item list-group-item-action"><a href="products/">Manage Products</a></li>
                        <li class="list-group-item list-group-item-action"><a href="establishments/">Manage Establishments</a></li>
                        <li class="list-group-item list-group-item-action"><a href="alerts/alerts.html">Manage Alerts</a></li>
                        <li class="list-group-item list-group-item-action"><a href="mashgiach-logs/">Mashgiach Logs</a></li>
                        <li class="list-group-item list-group-item-action"><a href="invoice.html">Invoicing</a></li>
                        <li class="list-group-item list-group-item-action"><a href="payroll/payroll-employee.html">My Payroll</a></li>
                        <li class="list-group-item list-group-item-action"><a href="payroll/payroll-admin.html">Manage Payroll</a></li>
                    </ul>
                </div>

                <!-- Mashgiach Links Section -->
                <div id="mashgiach-links" class="hidden">
                    <hr>
                    <h5 class="mb-3">Mashgiach Area</h5>
                    <ul class="list-group mb-3">
                        <li class="list-group-item list-group-item-action"><a href="mashgiach-logs/">Mashgiach Logs</a></li>
                        <li class="list-group-item list-group-item-action"><a href="payroll/payroll-employee.html">My Payroll</a></li>
                    </ul>
                </div>

                <!-- Logout Button -->
                <div class="d-grid">
                    <button id="logout-btn" class="btn btn-danger btn-lg" onclick="netlifyIdentity.logout()">Logout</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- Debug: Check if the object exists immediately after script load ---
        console.log('Netlify Identity object on window:', window.netlifyIdentity);

        // Check if the object exists before trying to initialize
        if (window.netlifyIdentity) {
            // Initialize Netlify Identity
            window.netlifyIdentity.init();

            // --- DOM References ---
            const loginFormContainer = document.getElementById('login-form-container');
            const loggedInContent = document.getElementById('logged-in-content');
            const customLoginForm = document.getElementById('custom-login-form');
            const loginEmailInput = document.getElementById('login-email');
            const loginPasswordInput = document.getElementById('login-password');
            const loginSubmitBtn = document.getElementById('login-submit-btn');
            const loginMessageArea = document.getElementById('login-message-area');
            const userGreeting = document.getElementById('user-greeting');
            const adminLinks = document.getElementById('admin-links');
            const mashgiachLinks = document.getElementById('mashgiach-links');

            // --- Helper Functions ---
            function showLoginMessage(type, text) {
                loginMessageArea.className = `login-message ${type}`;
                loginMessageArea.textContent = text;
                loginMessageArea.style.display = 'block';
            }

            function hideLoginMessage() {
                loginMessageArea.style.display = 'none';
                loginMessageArea.textContent = '';
                loginMessageArea.className = 'login-message';
            }

            // --- Update UI Function ---
            function updateUI(user) {
                if (user) {
                    loginFormContainer.classList.add('hidden');
                    loggedInContent.classList.remove('hidden');
                    userGreeting.textContent = `Welcome, ${user.user_metadata?.full_name || user.email}!`;
                    const adminRoles = ['admin', 'manager'];
                    const mashgiachRole = 'mashgiach';
                    const userRoles = user.app_metadata?.roles || [];
                    const isAdmin = userRoles.some(role => adminRoles.includes(role));
                    const isMashgiach = userRoles.includes(mashgiachRole);

                    adminLinks.classList.toggle('hidden', !isAdmin);
                    mashgiachLinks.classList.toggle('hidden', isAdmin || !isMashgiach); // Hide if admin OR if not mashgiach

                } else {
                    loginFormContainer.classList.remove('hidden');
                    loggedInContent.classList.add('hidden');
                    adminLinks.classList.add('hidden');
                    mashgiachLinks.classList.add('hidden');
                    userGreeting.textContent = '';
                    hideLoginMessage();
                }
            }

            // --- Netlify Identity Event Listeners ---
            window.netlifyIdentity.on('init', user => {
                console.log('Netlify Identity: init event', user);
                updateUI(user);
            });

            window.netlifyIdentity.on('login', user => {
                console.log('Netlify Identity: login event', user);
                updateUI(user);
                window.netlifyIdentity.close();
            });

            window.netlifyIdentity.on('logout', () => {
                console.log('Netlify Identity: logout event');
                updateUI(null);
            });

            window.netlifyIdentity.on('error', err => {
                console.error('Netlify Identity Error:', err);
                // Display a more generic error for non-login specific issues
                // showLoginMessage('error', `Authentication system error: ${err.message}`);
            });

            // --- Custom Login Form Submit Handler ---
            if (customLoginForm) {
                customLoginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    hideLoginMessage();
                    loginSubmitBtn.disabled = true;
                    loginSubmitBtn.textContent = 'Logging in...';

                    const email = loginEmailInput.value;
                    const password = loginPasswordInput.value;

                    // --- Debug: Check the object right before calling login ---
                    console.log('Attempting login. Netlify Identity object:', window.netlifyIdentity);

                    // Ensure the login function exists before calling
                    if (typeof window.netlifyIdentity.login !== 'function') {
                         console.error('Error: window.netlifyIdentity.login is still not a function!');
                         showLoginMessage('error', 'Login function is not available. Please refresh.');
                         loginSubmitBtn.disabled = false;
                         loginSubmitBtn.textContent = 'Login';
                         return; // Stop execution
                    }

                    try {
                        // Attempt login using Netlify Identity API
                        const user = await window.netlifyIdentity.login(email, password, true);
                        // Success is handled by the 'login' event listener
                        console.log('Login call successful (event listener will update UI):', user);
                    } catch (err) {
                        console.error('Custom Login Error:', err);
                        // Handle specific login errors (like wrong password)
                        showLoginMessage('error', `Login failed: ${err.message || 'Incorrect email or password.'}`);
                        loginSubmitBtn.disabled = false;
                        loginSubmitBtn.textContent = 'Login';
                    }
                });
            }

        } else {
            // --- Critical Error: Netlify Identity did not load ---
            console.error("CRITICAL: Netlify Identity widget script did not load or `window.netlifyIdentity` is not defined.");
            // Optionally display an error message to the user on the page itself
            const body = document.querySelector('body');
            if (body) {
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'Error: Authentication service failed to load. Please check your connection and refresh the page.';
                errorDiv.style.color = 'red';
                errorDiv.style.padding = '20px';
                errorDiv.style.textAlign = 'center';
                body.insertBefore(errorDiv, body.firstChild); // Add message at the top
            }
            // Hide the login form if the widget failed to load
            const loginContainer = document.getElementById('login-form-container');
            if(loginContainer) loginContainer.classList.add('hidden');
        }

    </script>
</body>
</html>
