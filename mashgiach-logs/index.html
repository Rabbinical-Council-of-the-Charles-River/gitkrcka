<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mashgiach Logs</title>
    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Your Custom CSS (Adjust path if needed) -->
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .hidden {
            display: none !important;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.success {
             background-color: #d4edda;
             color: #155724;
             border: 1px solid #c3e6cb;
        }
        .text-right {
             text-align: right !important;
        }
        .table-wrapper {
            background: #fff;
            padding: 20px 25px;
            margin: 30px auto;
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,.05);
            max-width: 1200px; /* Adjusted width */
        }
        .table-title h2 {
            margin: 5px 0 0;
            font-size: 24px;
        }
        .table-title .btn {
            float: right;
            height: 34px;
            font-size: 14px;
        }
        .info-icon {
            font-size: 1rem;
            vertical-align: middle;
            margin-left: 4px;
            cursor: help;
            color: #6c757d;
        }
        .select-checkbox-cell, .select-checkbox-header {
            width: 1%;
            white-space: nowrap;
            text-align: center;
        }
        #add-selected-to-invoice-btn {
            margin-left: 10px;
        }
        /* Billing Status Badges */
        .badge {
            padding: 0.4em 0.6em;
            font-size: 0.75em;
            font-weight: 600;
            color: white; /* Default text color for badges */
        }
        .status-billed { background-color: #198754; } /* Success */
        .status-unbilled { background-color: #ffc107; color: black; } /* Warning */
        /* Style for disabled checkboxes */
        .log-select-checkbox:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Optional: Style for billed rows */
        .table-secondary {
             --bs-table-bg: #e9ecef; /* Lighter gray for billed rows */
             --bs-table-striped-bg: #e1e5e9;
        }
        /* Class to hide ADMIN-ONLY FUNCTIONALITY elements */
        .admin-only-func { display: none; }
        /* Class for the billing status field in the edit modal */
        .admin-only-field { display: none; }

    </style>
</head>

<body>
    <!-- Login Section -->
    <div id="login-section">
        <div class="container"
            style="max-width: 400px; margin: 50px auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);">
            <h1 class="text-center">Login Required</h1>
            <div id="message" class="message"></div>
            <div class="d-grid gap-2">
                <button id="netlify-login-button" class="btn btn-primary btn-lg">
                    Login with Netlify Identity
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Content -->
    <div id="logs-content" class="hidden">
        <div class="container-fluid">
            <div class="table-wrapper">
                <div class="table-title">
                    <div class="row">
                        <div class="col-sm-6">
                            <h2>KRCKA <b>Mashgiach Logs</b></h2>
                            <a href="../index.html">Home</a>
                            <!-- MODIFIED: Added admin-only-func class -->
                             <!-- MODIFIED: Added admin-only-func class -->
 <div class="">
    <strong>Selected Total Time:</strong> <span id="selected-total-time">0 hours 0 minutes</span>
</div>

                        </div>
                        <div class="col-sm-6 text-right">
                             <!-- MODIFIED: Added admin-only-func class -->
                             <a href="#" class="btn btn-primary admin-only-func" id="add-selected-to-invoice-btn" style="display: none;">
                                <i class="material-icons">&#xE145;</i> <span>Add Selected to Invoice</span>
                            </a>
                            <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addLogModal">
                                <i class="material-icons">&#xE147;</i> <span>Add New Log</span>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="table-responsive mt-3">
                    <table id="mashgiach-log-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <!-- Columns are always visible -->
                                <th class="select-checkbox-header"><input type="checkbox" id="select-all-logs" title="Select All (Admin)"></th>
                                <th>Mashgiach</th>
                                <th>Venue</th>
                                <th>Time/Date</th>
                                <th>Description</th>
                                <th>Time Spent
                                    <i class="material-icons info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Format: e.g., 120 (for 120 minutes)">help_outline</i>
                                </th>
                                <th>Billing Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Log entries populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add Log Modal -->
        <div id="addLogModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="addLogModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="add-log-form">
                        <div class="modal-header">
                            <h4 class="modal-title" id="addLogModalLabel">Add New Log</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="log-venue" class="form-label">Venue</label>
                                <input type="text" id="log-venue" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="log-description" class="form-label">Description</label>
                                <textarea id="log-description" class="form-control" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="log-time-spent" class="form-label">Time Spent (Minutes)
                                    <i class="material-icons info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Enter total time in minutes (e.g., 90 for 1.5 hours)">help_outline</i>
                                </label>
                                <input type="number" id="log-time-spent" class="form-control" required min="1" placeholder="e.g., 120">
                            </div>
                             <!-- Billing status defaults to 'unbilled', no need for input here -->
                        </div>
                        <div class="modal-footer">
                            <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                            <input type="submit" class="btn btn-success" value="Add">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Log Modal -->
        <div id="editLogModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editLogModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="edit-log-form">
                        <div class="modal-header">
                            <h4 class="modal-title" id="editLogModalLabel">Edit Log</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="edit-log-venue" class="form-label">Venue</label>
                                <input type="text" id="edit-log-venue" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-log-description" class="form-label">Description</label>
                                <textarea id="edit-log-description" class="form-control" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit-log-time-spent" class="form-label">Time Spent (Minutes)
                                     <i class="material-icons info-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Enter total time in minutes (e.g., 90 for 1.5 hours)">help_outline</i>
                                </label>
                                <input type="number" id="edit-log-time-spent" class="form-control" required min="1" placeholder="e.g., 120">
                            </div>
                            <!-- MODIFIED: Added admin-only-field class -->
                            <div class="mb-3 admin-only-field">
                                <label for="edit-billing-status" class="form-label">Billing Status (Admin Only)</label>
                                <select id="edit-billing-status" class="form-select" required>
                                    <option value="unbilled">Unbilled</option>
                                    <option value="billed">Billed</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                            <input type="submit" class="btn btn-info" value="Save">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Delete Log Modal -->
        <div id="deleteLogModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteLogModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="delete-log-form">
                        <div class="modal-header">
                            <h4 class="modal-title" id="deleteLogModalLabel">Delete Log Entry</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete this log entry?</p>
                            <p class="text-warning"><small>This action cannot be undone.</small></p>
                        </div>
                        <div class="modal-footer">
                            <input type="button" class="btn btn-secondary" data-bs-dismiss="modal" value="Cancel">
                            <input type="submit" class="btn btn-danger" value="Delete">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div> <!-- End Logs Content -->

    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <!-- Netlify Identity Widget -->
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg", // Replace if needed
            authDomain: "richardrccr-10a9d.firebaseapp.com", // Replace if needed
            projectId: "richardrccr-10a9d", // Replace if needed
            storageBucket: "richardrccr-10a9d.firebasestorage.app", // Replace if needed
            messagingSenderId: "867270362103", // Replace if needed
            appId: "1:867270362103:web:7653459445810350b864f2" // Replace if needed
        };

        // --- Initialize Firebase ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // --- Firestore Collection Reference ---
        const mashgiachLogRef = db.collection('mashgiach-logs');

        // --- DOM Element References ---
        const loginSection = document.getElementById('login-section');
        const logsContent = document.getElementById('logs-content');
        const netlifyLoginButton = document.getElementById('netlify-login-button');
        const messageDiv = document.getElementById('message');
        const logsTable = document.getElementById('mashgiach-log-table');
        const logsTableBody = document.querySelector('#mashgiach-log-table tbody');
        const addLogForm = document.getElementById('add-log-form');
        const editLogForm = document.getElementById('edit-log-form');
        const deleteLogForm = document.getElementById('delete-log-form');
        const addSelectedToInvoiceBtn = document.getElementById('add-selected-to-invoice-btn');
        const selectAllCheckbox = document.getElementById('select-all-logs');
        const selectedTotalTimeDisplay = document.getElementById('selected-total-time');

        // --- Netlify Identity Initialization ---
        const netlifyIdentity = window.netlifyIdentity;
        if (netlifyIdentity) {
            netlifyIdentity.init();
        } else {
            console.error("Netlify Identity widget not loaded.");
            if(showMessage) showMessage('error', 'Authentication service failed to load.');
        }

        // --- State Variables ---
        let selectedLogIds = new Set();
        let currentUser = null; // Store current user info
        let currentUserIsAdmin = false; // Flag for admin status

        // --- Configuration ---
        const MASHGIACH_HOURLY_RATE = 50.00; // ADJUST AS NEEDED!

        // --- Helper Functions ---
        function showMessage(type, text) {
            if (messageDiv) {
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = text;
                messageDiv.style.display = 'block';
            } else { console.warn("Message div not found"); }
        }

        function clearMessage() {
            if (messageDiv) {
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
                messageDiv.className = 'message';
            }
        }

        function formatFirestoreTimestamp(timestamp) {
            if (timestamp && typeof timestamp.toDate === 'function') {
                return timestamp.toDate().toLocaleString(); // Consider locale options
            }
            return 'N/A';
        }

        function getBillingStatusBadge(status) {
            const statusLower = (status || 'unbilled').toLowerCase();
            const badgeClass = `status-${statusLower}`;
            const statusText = statusLower.charAt(0).toUpperCase() + statusLower.slice(1); // Capitalize
            return `<span class="badge ${badgeClass}">${statusText}</span>`;
        }

        // --- UI Update Logic ---
        function updateAccessUI(user) {
            currentUser = user; // Store user globally
            const userRoles = user?.app_metadata?.roles || [];
            currentUserIsAdmin = userRoles.includes('admin');
            const isMashgiach = userRoles.includes('mashgiach');
            const canAccess = currentUserIsAdmin || isMashgiach;

            // Toggle visibility based on access
            if (canAccess) {
                loginSection.classList.add('hidden');
                logsContent.classList.remove('hidden');
                clearMessage();
                displayMashgiachLogs(); // Load logs based on role
                initializeTooltips();

                // Show/Hide Admin-specific FUNCTIONALITY elements
                const adminOnlyFuncElements = logsContent.querySelectorAll('.admin-only-func');
                adminOnlyFuncElements.forEach(el => {
                    el.style.display = currentUserIsAdmin ? '' : 'none'; // Show if admin, hide if not
                });
                // Show/Hide Admin-specific FIELD elements (like in modals)
                const adminOnlyFieldElements = logsContent.querySelectorAll('.admin-only-field');
                 adminOnlyFieldElements.forEach(el => {
                    el.style.display = currentUserIsAdmin ? '' : 'none'; // Show if admin, hide if not
                });

                // Disable admin checkboxes for non-admins
                if (selectAllCheckbox) selectAllCheckbox.disabled = !currentUserIsAdmin;


            } else {
                loginSection.classList.remove('hidden');
                logsContent.classList.add('hidden');
                if (user) { // If logged in but no access
                     if(showMessage) showMessage('error', 'Access Denied. Required roles: admin or mashgiach.');
                } else { // Not logged in
                     clearMessage();
                }
                if (logsTableBody) logsTableBody.innerHTML = '';
                selectedLogIds.clear();
                updateAddToInvoiceButtonVisibility();
                if (selectedTotalTimeDisplay) selectedTotalTimeDisplay.textContent = '0 hours 0 minutes';
            }
        }

        function initializeTooltips() {
            try {
                const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    const existingTooltip = bootstrap.Tooltip.getInstance(tooltipTriggerEl);
                    if (existingTooltip) {
                        existingTooltip.dispose();
                    }
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            } catch (e) {
                console.error("Error initializing tooltips:", e);
            }
        }

        function updateAddToInvoiceButtonVisibility() {
            // Only show if admin and items are selected
            if (addSelectedToInvoiceBtn) {
                const hasSelectable = selectedLogIds.size > 0;
                // Button visibility is now controlled by .admin-only-func class in updateAccessUI
                // We only need to manage the disabled state and text based on selection
                if (currentUserIsAdmin) {
                    addSelectedToInvoiceBtn.disabled = !hasSelectable;
                    addSelectedToInvoiceBtn.querySelector('span').textContent = 'Add Selected to Invoice';
                } else {
                    // Ensure it's hidden if somehow the class wasn't applied
                    addSelectedToInvoiceBtn.style.display = 'none';
                }
            }
        }


        function calculateSelectedTime() {
            // Only calculate if admin
            if (!currentUserIsAdmin || !logsTableBody || !selectedTotalTimeDisplay) {
                 // Visibility controlled by .admin-only-func, just clear text if not admin
                 if (selectedTotalTimeDisplay) selectedTotalTimeDisplay.textContent = '0 hours 0 minutes';
                 return;
            }

            let totalMinutes = 0;
            const checkedCheckboxes = logsTableBody.querySelectorAll('.log-select-checkbox:checked');

            checkedCheckboxes.forEach(checkbox => {
                const duration = parseInt(checkbox.dataset.durationMinutes || '0', 10);
                if (!isNaN(duration)) {
                    totalMinutes += duration;
                }
            });

            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            selectedTotalTimeDisplay.textContent = `${hours} hours ${minutes} minutes`;
        }

        function handleCheckboxChange(event) {
            const checkbox = event.target;
            if (!checkbox.classList.contains('log-select-checkbox')) return;

            // Only admins can use checkboxes for invoicing
            if (!currentUserIsAdmin) {
                checkbox.checked = false; // Prevent checking for non-admins
                checkbox.disabled = true; // Ensure it's disabled
                return;
            }

            // --- Admin Checkbox Logic ---
            const logId = checkbox.dataset.id;
            const status = checkbox.dataset.status;

            if (status !== 'billed') {
                if (checkbox.checked) {
                    selectedLogIds.add(logId);
                } else {
                    selectedLogIds.delete(logId);
                }

                const unbilledCheckboxes = logsTableBody?.querySelectorAll('.log-select-checkbox[data-status="unbilled"]:not(:disabled)');
                const checkedUnbilledCount = logsTableBody?.querySelectorAll('.log-select-checkbox[data-status="unbilled"]:checked').length || 0;

                if (selectAllCheckbox) {
                    if (unbilledCheckboxes && checkedUnbilledCount === unbilledCheckboxes.length && unbilledCheckboxes.length > 0) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.indeterminate = false;
                    } else if (checkedUnbilledCount > 0) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = true;
                    } else {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    }
                }
            } else {
                 // If it's billed, don't allow selection for invoicing, but allow for time calc
                 if (checkbox.checked) {
                     // Don't add to selectedLogIds for invoicing
                 }
            }

            updateAddToInvoiceButtonVisibility();
            calculateSelectedTime();
        }

        function handleSelectAllChange(event) {
            // Only admins can use select-all
            if (!currentUserIsAdmin) {
                event.target.checked = false;
                event.target.disabled = true; // Ensure disabled
                return;
            }

            // --- Admin Select All Logic ---
            const isChecked = event.target.checked;
            const allCheckboxes = logsTableBody?.querySelectorAll('.log-select-checkbox');
            if (!allCheckboxes) return;

            selectedLogIds.clear();

            allCheckboxes.forEach(checkbox => {
                const status = checkbox.dataset.status;
                // Only check unbilled items for invoicing purposes
                if (status !== 'billed') {
                    checkbox.checked = isChecked;
                    if (isChecked) {
                        selectedLogIds.add(checkbox.dataset.id);
                    }
                } else {
                    // Keep billed items unchecked by select-all for invoicing
                    checkbox.checked = false;
                }
            });

            updateAddToInvoiceButtonVisibility();
            calculateSelectedTime();
             if(selectAllCheckbox) selectAllCheckbox.indeterminate = false;
        }

        async function prepareAndRedirectToInvoice() {
            // Only admins can perform this action
            if (!currentUserIsAdmin) return;

            const unbilledSelectedIds = Array.from(selectedLogIds);
            if (unbilledSelectedIds.length === 0) {
                alert("Please select at least one 'Unbilled' log entry to add to the invoice.");
                return;
            }

            console.log("Processing Unbilled Log IDs:", unbilledSelectedIds);
            addSelectedToInvoiceBtn.disabled = true;
            addSelectedToInvoiceBtn.querySelector('span').textContent = 'Processing...';

            let invoiceItems = [];
            let successfullyProcessedLogIds = [];

            try {
                const fetchPromises = unbilledSelectedIds.map(id => mashgiachLogRef.doc(id).get());
                const logDocs = await Promise.all(fetchPromises);

                invoiceItems = logDocs
                    .filter(doc => {
                        const data = doc.data();
                        // Double check it's unbilled before adding
                        return doc.exists && data && data.billingStatus !== 'billed';
                    })
                    .map(doc => {
                        const logData = doc.data();
                        const minutes = logData.timeSpentMinutes || 0;
                        const hours = minutes > 0 ? (minutes / 60).toFixed(2) : 0;
                        const description = `Mashgiach Visit: ${logData.venue || 'N/A'} (${formatFirestoreTimestamp(logData.dateTime)}) - ${logData.description || ''}`;
                        successfullyProcessedLogIds.push(doc.id);
                        return {
                            description: description.substring(0, 200),
                            quantity: parseFloat(hours),
                            unitPrice: MASHGIACH_HOURLY_RATE,
                        };
                    });

                if (invoiceItems.length === 0) {
                     alert("No valid 'Unbilled' logs found among the selection. Please refresh and try again.");
                     updateAddToInvoiceButtonVisibility(); // Re-enable button
                     // No need to change text, updateAddToInvoiceButtonVisibility handles it
                     return;
                }

                const batch = db.batch();
                successfullyProcessedLogIds.forEach(logId => {
                    const docRef = mashgiachLogRef.doc(logId);
                    batch.update(docRef, {
                        billingStatus: 'billed',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await batch.commit();
                console.log(`Successfully marked ${successfullyProcessedLogIds.length} logs as billed.`);

                sessionStorage.setItem('pendingInvoiceItems', JSON.stringify(invoiceItems));
                console.log("Items stored in sessionStorage:", invoiceItems);
                window.location.href = '../invoice.html';

            } catch (error) {
                console.error("Error processing logs for invoice:", error);
                alert(`An error occurred: ${error.message}. Some logs might not have been marked as billed.`);
                updateAddToInvoiceButtonVisibility(); // Re-enable button on error
            }
        }

        // --- Firestore Operations ---

        async function addMashgiachLogSubmit(event) {
            event.preventDefault();
            // User check happens in updateAccessUI, currentUser is set
            if (!currentUser) {
                if(showMessage) showMessage('error', "You must be logged in to add a log.");
                return;
            }
            const venue = document.getElementById('log-venue').value.trim();
            const description = document.getElementById('log-description').value.trim();
            const timeSpent = parseInt(document.getElementById('log-time-spent').value, 10);
            if (!venue || !description || isNaN(timeSpent) || timeSpent <= 0) {
                 alert("Please fill in all fields correctly. Time spent must be a positive number (minutes).");
                 return;
            }

            try {
                const logEntry = {
                    mashgiachId: currentUser.id, // Use logged-in user's ID
                    mashgiachName: currentUser.user_metadata?.full_name || currentUser.email, // Use logged-in user's name/email
                    venue: venue,
                    dateTime: firebase.firestore.FieldValue.serverTimestamp(),
                    description: description,
                    timeSpentMinutes: timeSpent,
                    billingStatus: 'unbilled', // Always default to unbilled
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                await mashgiachLogRef.add(logEntry);
                console.log("Mashgiach log written.");
                const addModalEl = document.getElementById('addLogModal');
                const addModalInstance = bootstrap.Modal.getInstance(addModalEl);
                if(addModalInstance) addModalInstance.hide();
                displayMashgiachLogs(); // Refresh the view
            } catch (error) {
                 console.error("Error adding Mashgiach log: ", error);
                 if(showMessage) showMessage('error', `Failed to add log: ${error.message}`);
            }
        }

        // MODIFIED: displayMashgiachLogs - Filters by user if not admin, but shows all columns
        async function displayMashgiachLogs() {
            if (!logsTableBody || !currentUser) return; // Need user info

            const colspan = 8; // Always 8 columns now
            logsTableBody.innerHTML = `<tr><td colspan="${colspan}">Loading logs...</td></tr>`;

            selectedLogIds.clear();
            updateAddToInvoiceButtonVisibility();
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.disabled = !currentUserIsAdmin; // Ensure state is correct on load
            }

            try {
                let query = mashgiachLogRef;

                // Filter by mashgiachId if the user is NOT an admin
                if (!currentUserIsAdmin) {
                    query = query.where('mashgiachId', '==', currentUser.id);
                }

                // Always order by date
                query = query.orderBy('dateTime', 'desc');

                const querySnapshot = await query.get();

                if (querySnapshot.empty) {
                    logsTableBody.innerHTML = `<tr><td colspan="${colspan}">No logs found${!currentUserIsAdmin ? ' for your user' : ''}.</td></tr>`;
                    calculateSelectedTime();
                    return;
                }

                let tableContent = '';
                querySnapshot.forEach(doc => {
                    const log = doc.data();
                    const logId = doc.id;
                    const timeInMinutes = log.timeSpentMinutes || 0;
                    const timeDisplay = timeInMinutes ? `${timeInMinutes} min` : 'N/A';
                    const billingStatus = log.billingStatus || 'unbilled';
                    const isBilled = billingStatus === 'billed';
                    // Checkbox is disabled if not admin OR if item is billed (for invoicing)
                    const checkboxDisabled = !currentUserIsAdmin; // Simplified: Only admins can interact

                    tableContent += `
                        <tr data-id="${logId}" class="${isBilled ? 'table-secondary' : ''}">
                            <td class="select-checkbox-cell">
                                <input type="checkbox" class="log-select-checkbox" data-id="${logId}"
                                       data-duration-minutes="${timeInMinutes}"
                                       data-status="${billingStatus}"
                                       title="${currentUserIsAdmin ? (isBilled ? 'Already Billed' : 'Select Log') : 'Admin Only'}"
                                       ${checkboxDisabled ? 'disabled' : ''}>
                            </td>
                            <td>${log.mashgiachName || log.mashgiachId || 'Unknown'}</td>
                            <td>${log.venue || 'N/A'}</td>
                            <td>${formatFirestoreTimestamp(log.dateTime)}</td>
                            <td>${log.description || ''}</td>
                            <td>${timeDisplay}</td>
                            <td>${getBillingStatusBadge(billingStatus)}</td>
                            <td>
                                <a href="#" class="edit js-edit-log" data-id="${logId}" title="Edit Log">
                                    <i class="material-icons">&#xE254;</i>
                                </a>
                                <a href="#" class="delete js-delete-log" data-id="${logId}" title="Delete Log">
                                    <i class="material-icons">&#xE872;</i>
                                </a>
                            </td>
                        </tr>
                    `;
                });

                logsTableBody.innerHTML = tableContent;
                initializeTooltips();
                calculateSelectedTime(); // Calculate time for admin if applicable

            } catch (error) {
                console.error("Error fetching Mashgiach logs: ", error);
                logsTableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-danger">Error loading logs: ${error.message}</td></tr>`;
                calculateSelectedTime(); // Reset time display on error
            }
        }

        // MODIFIED: openEditLogModal - Added ownership check
        async function openEditLogModal(logId) {
            if (!currentUser) return; // Should not happen if UI is correct
            editLogForm.setAttribute('data-edit-id', logId);
             try {
                const doc = await mashgiachLogRef.doc(logId).get();
                if (doc.exists) {
                    const logData = doc.data();

                    // *** Ownership Check ***
                    if (!currentUserIsAdmin && logData.mashgiachId !== currentUser.id) {
                        alert("Access Denied: You can only edit your own log entries.");
                        return; // Prevent opening modal
                    }
                    // *** End Ownership Check ***

                    document.getElementById('edit-log-venue').value = logData.venue || '';
                    document.getElementById('edit-log-description').value = logData.description || '';
                    document.getElementById('edit-log-time-spent').value = logData.timeSpentMinutes || '';

                    // Only populate status if admin (field visibility controlled by CSS/updateAccessUI)
                    if (currentUserIsAdmin) {
                        document.getElementById('edit-billing-status').value = logData.billingStatus || 'unbilled';
                    }

                    const editModalEl = document.getElementById('editLogModal');
                    const modal = bootstrap.Modal.getOrCreateInstance(editModalEl);
                    modal.show();
                } else {
                    console.error("Log document not found for editing:", logId);
                    if(showMessage) showMessage('error', 'Could not find the log entry to edit.');
                }
            } catch (error) {
                 console.error("Error getting document for edit:", error);
                 if(showMessage) showMessage('error', `Error loading log for editing: ${error.message}`);
            }
        }

        // MODIFIED: editLogSubmit - Added ownership check
        async function editLogSubmit(event) {
            event.preventDefault();
            const logId = editLogForm.getAttribute('data-edit-id');
            if (!logId || !currentUser) return;

            const venue = document.getElementById('edit-log-venue').value.trim();
            const description = document.getElementById('edit-log-description').value.trim();
            const timeSpent = parseInt(document.getElementById('edit-log-time-spent').value, 10);
            // Get status only if admin, otherwise keep it unchanged
            const billingStatusInput = document.getElementById('edit-billing-status');
            const newBillingStatus = currentUserIsAdmin ? billingStatusInput.value : undefined; // Undefined means don't update if not admin

             if (!venue || !description || isNaN(timeSpent) || timeSpent <= 0) {
                 alert("Please fill in all fields correctly. Time spent must be a positive number (minutes).");
                 return;
            }

            try {
                // *** Ownership Check before update ***
                const docRef = mashgiachLogRef.doc(logId);
                const docSnap = await docRef.get();
                if (!docSnap.exists) {
                    throw new Error("Log entry not found.");
                }
                const logData = docSnap.data();
                if (!currentUserIsAdmin && logData.mashgiachId !== currentUser.id) {
                    alert("Access Denied: You can only save changes to your own log entries.");
                    return; // Prevent saving
                }
                // *** End Ownership Check ***

                const updateData = {
                    venue: venue,
                    description: description,
                    timeSpentMinutes: timeSpent,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Only include billingStatus in update if admin changed it
                if (currentUserIsAdmin && newBillingStatus !== undefined) {
                    updateData.billingStatus = newBillingStatus;
                }

                await docRef.update(updateData);

                const editModalEl = document.getElementById('editLogModal');
                const modal = bootstrap.Modal.getInstance(editModalEl);
                if(modal) modal.hide();
                displayMashgiachLogs(); // Refresh table
            } catch (error) {
                 console.error("Error updating document: ", error);
                 if(showMessage) showMessage('error', `Error saving changes: ${error.message}`);
            }
        }

         // MODIFIED: openDeleteLogModal - Added ownership check (pre-check)
        async function openDeleteLogModal(logId) {
            if (!currentUser) return;
            // *** Ownership Pre-Check ***
             try {
                const doc = await mashgiachLogRef.doc(logId).get();
                if (doc.exists) {
                    const logData = doc.data();
                    if (!currentUserIsAdmin && logData.mashgiachId !== currentUser.id) {
                        alert("Access Denied: You can only delete your own log entries.");
                        return; // Prevent opening modal
                    }
                } else {
                    // Log doesn't exist, maybe already deleted?
                    if(showMessage) showMessage('warning', 'Log entry not found.');
                    return; // Don't open modal if not found
                }
            } catch (error) {
                 console.error("Error checking ownership before delete:", error);
                 if(showMessage) showMessage('error', `Could not verify log ownership: ${error.message}`);
                 return; // Don't open modal on error
            }
            // *** End Ownership Pre-Check ***

            // If checks pass, set ID and show modal
            deleteLogForm.setAttribute('data-delete-id', logId);
            const deleteModalEl = document.getElementById('deleteLogModal');
            const modal = bootstrap.Modal.getOrCreateInstance(deleteModalEl);
            modal.show();
        }

        // MODIFIED: deleteLogSubmit - Added ownership check
        async function deleteLogSubmit(event) {
            event.preventDefault();
            const logId = deleteLogForm.getAttribute('data-delete-id');
             if (!logId || !currentUser) return;

            try {
                 // *** Ownership Check before delete ***
                const docRef = mashgiachLogRef.doc(logId);
                const docSnap = await docRef.get();
                if (!docSnap.exists) {
                    // Already deleted? Just close modal and refresh
                    console.warn("Log entry not found during delete submit, likely already deleted.");
                } else {
                    const logData = docSnap.data();
                    if (!currentUserIsAdmin && logData.mashgiachId !== currentUser.id) {
                        alert("Access Denied: You can only delete your own log entries.");
                        // Don't close modal or refresh if access denied
                        return; // Prevent deletion
                    }
                     // Proceed with delete
                    await docRef.delete();
                    console.log("Document successfully deleted!");
                }
                // *** End Ownership Check ***

                // Close modal and refresh table only if delete was attempted/successful or log was already gone
                const deleteModalEl = document.getElementById('deleteLogModal');
                const modal = bootstrap.Modal.getInstance(deleteModalEl);
                if(modal) modal.hide();
                displayMashgiachLogs(); // Refresh table

            } catch (error) {
                 console.error("Error deleting document: ", error);
                 if(showMessage) showMessage('error', `Error deleting log: ${error.message}`);
            }
        }

        // --- Event Listeners ---

        if (netlifyLoginButton) {
            netlifyLoginButton.addEventListener('click', () => {
                netlifyIdentity.open();
            });
        }

        // Use updateAccessUI for auth changes
        netlifyIdentity.on('init', user => updateAccessUI(user));
        netlifyIdentity.on('login', user => {
            updateAccessUI(user);
            netlifyIdentity.close();
        });
        netlifyIdentity.on('logout', () => updateAccessUI(null));

        if (addLogForm) addLogForm.addEventListener('submit', addMashgiachLogSubmit);
        if (editLogForm) editLogForm.addEventListener('submit', editLogSubmit);
        if (deleteLogForm) deleteLogForm.addEventListener('submit', deleteLogSubmit);

        // Table click listener (delegated)
        if (logsTableBody) {
            logsTableBody.addEventListener('click', (event) => {
                const target = event.target;

                // Handle Checkbox clicks
                if (target.classList.contains('log-select-checkbox')) {
                     handleCheckboxChange(event); // Function handles admin check internally
                     return;
                }

                // Handle Edit/Delete link clicks
                const targetLink = target.closest('a'); // Find nearest link ancestor
                if (!targetLink) return; // Exit if click wasn't on or inside a link

                const logId = targetLink.getAttribute('data-id');
                if (!logId) return; // Exit if link has no data-id

                if (targetLink.classList.contains('js-edit-log')) {
                    event.preventDefault();
                    openEditLogModal(logId); // Function handles ownership check
                } else if (targetLink.classList.contains('js-delete-log')) {
                     event.preventDefault();
                    openDeleteLogModal(logId); // Function handles ownership check
                }
            });
        }

        // Select All Checkbox listener
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', handleSelectAllChange); // Function handles admin check
        }

        // Add Selected to Invoice Button listener
        if (addSelectedToInvoiceBtn) {
            addSelectedToInvoiceBtn.addEventListener('click', (event) => {
                event.preventDefault();
                prepareAndRedirectToInvoice(); // Function handles admin check
            });
        }

        // Modal cleanup listeners
        const addModalEl = document.getElementById('addLogModal');
        if(addModalEl) addModalEl.addEventListener('hidden.bs.modal', () => addLogForm.reset());

        const editModalEl = document.getElementById('editLogModal');
        if(editModalEl) {
            editModalEl.addEventListener('hidden.bs.modal', () => {
                editLogForm.reset();
                editLogForm.removeAttribute('data-edit-id');
            });
        }

        const deleteModalEl = document.getElementById('deleteLogModal');
        if(deleteModalEl) {
            deleteModalEl.addEventListener('hidden.bs.modal', () => {
                deleteLogForm.removeAttribute('data-delete-id');
            });
        }

        // --- Initial Load ---
        // Handled by Netlify Identity 'init' event

    </script>

</body>
</html>
