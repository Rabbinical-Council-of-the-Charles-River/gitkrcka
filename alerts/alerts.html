<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kashrus Alerts</title>
    <!-- Netlify Identity Widget -->
    <script src="https://cdn.jsdelivr.net/npm/netlify-identity-widget@1.9.1/build/netlify-identity-widget.min.js"></script>
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        /* Add any specific styles for the alerts page */
        .admin-controls {
            display: none; /* Hide admin controls by default */
        }
        .card { margin-bottom: 1rem; }
        /* Style for login/logout buttons if needed */
        #login-prompt button { margin-right: 0.5rem; }
        .alert-content { white-space: pre-wrap; } /* Preserve line breaks in alert text */
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>Kashrus Alerts</h1>
            <!-- Area for Login/Logout buttons -->
            <div id="login-prompt">
                 <button id="login-btn" class="btn btn-sm btn-outline-primary" onclick="netlifyIdentity.open()">Admin Login</button>
                 <button id="logout-btn" class="btn btn-sm btn-outline-danger admin-controls" onclick="netlifyIdentity.logout()">Logout</button>
            </div>
        </div>

        <hr>

        <!-- "Add Alert" Button/Form Area - Only for Admins -->
        <div class="mb-3 admin-controls">
            <button id="add-alert-btn" class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#addAlertModal">Add New Alert</button>
            <!-- Add Alert Modal Triggered by the button above -->
        </div>

        <h2>Current Alerts</h2>
        <!-- Alerts List - Visible to Everyone, populated by Firebase -->
        <div id="alerts-list">
            <!-- Alerts will be loaded here -->
            <div id="loading-indicator" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>

        <div class="mt-4">
             <a href="/" class="btn btn-secondary">Back to Portal Home</a>
        </div>

    </div>

    <!-- Add Alert Modal -->
    <div class="modal fade" id="addAlertModal" tabindex="-1" aria-labelledby="addAlertModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addAlertModalLabel">Add New Alert</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="add-alert-form">
              <div class="mb-3">
                <label for="alert-title" class="form-label">Title</label>
                <input type="text" class="form-control" id="alert-title" required>
              </div>
              <div class="mb-3">
                <label for="alert-details" class="form-label">Details</label>
                <textarea class="form-control" id="alert-details" rows="5" required></textarea>
              </div>
              <!-- Add other fields if needed -->
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="save-alert-btn">Save Alert</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Alert Modal (Similar structure to Add, pre-filled) -->
    <div class="modal fade" id="editAlertModal" tabindex="-1" aria-labelledby="editAlertModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editAlertModalLabel">Edit Alert</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="edit-alert-form">
              <input type="hidden" id="edit-alert-id"> <!-- To store the ID of the alert being edited -->
              <div class="mb-3">
                <label for="edit-alert-title" class="form-label">Title</label>
                <input type="text" class="form-control" id="edit-alert-title" required>
              </div>
              <div class="mb-3">
                <label for="edit-alert-details" class="form-label">Details</label>
                <textarea class="form-control" id="edit-alert-details" rows="5" required></textarea>
              </div>
              <!-- Add other fields if needed -->
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="update-alert-btn">Update Alert</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteAlertModal" tabindex="-1" aria-labelledby="deleteAlertModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteAlertModalLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this alert?
            <p class="text-danger"><small>This action cannot be undone.</small></p>
            <input type="hidden" id="delete-alert-id">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
                // --- Firebase Configuration ---
        // IMPORTANT: Replace with your actual Firebase config
        // Consider using environment variables or a config file for security
        const firebaseConfig = {
            apiKey: "AIzaSyAhOboBWpkzHegBBXIwQBa6SWD7JoLJvUg", // Replace with your key
            authDomain: "richardrccr-10a9d.firebaseapp.com",   // Replace
            projectId: "richardrccr-10a9d",                 // Replace
            storageBucket: "richardrccr-10a9d.firebasestorage.app", // Replace
            messagingSenderId: "867270362103",              // Replace
            appId: "1:867270362103:web:7653459445810350b864f2" // Replace
        };

        // --- Initialize Firebase ---
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const alertsCollection = db.collection('alerts'); // Assuming your collection is named 'alerts'

        // --- DOM Elements ---
        const alertsListDiv = document.getElementById('alerts-list');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loginButton = document.getElementById('login-btn');
        // We select adminControls inside updateAdminUI now

        // Modals (using Bootstrap 5 instances for programmatic control)
        const addAlertModalEl = document.getElementById('addAlertModal');
        const addAlertModal = addAlertModalEl ? new bootstrap.Modal(addAlertModalEl) : null;
        const editAlertModalEl = document.getElementById('editAlertModal');
        const editAlertModal = editAlertModalEl ? new bootstrap.Modal(editAlertModalEl) : null;
        const deleteAlertModalEl = document.getElementById('deleteAlertModal');
        const deleteAlertModal = deleteAlertModalEl ? new bootstrap.Modal(deleteAlertModalEl) : null;


        // --- Alert Rendering ---
        function createAlertCard(doc) {
            const data = doc.data();
            const alertId = doc.id;

            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-id', alertId); // Add data-id for easier selection

            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';

            const title = document.createElement('h5');
            title.className = 'card-title';
            title.textContent = data.title || 'No Title';
            cardBody.appendChild(title);

            const details = document.createElement('p');
            details.className = 'card-text alert-content'; // Added class for styling
            details.textContent = data.details || 'No Details Provided.';
            cardBody.appendChild(details);

            const timestamp = document.createElement('small');
            timestamp.className = 'text-muted';
            let dateStr = 'Date not available';
            if (data.createdAt && data.createdAt.toDate) { // Check if it's a Firestore Timestamp
                try {
                    dateStr = data.createdAt.toDate().toLocaleDateString();
                } catch (e) { console.error("Error formatting date:", e); }
            } else if (data.createdAt) { // Handle if it's already a string/number
                 dateStr = new Date(data.createdAt).toLocaleDateString();
            }
            timestamp.textContent = `Posted on: ${dateStr}`;
            cardBody.appendChild(timestamp);

            // --- Admin Controls within the card ---
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'mt-2 admin-controls'; // Add class to hide/show

            const editButton = document.createElement('button');
            editButton.className = 'btn btn-sm btn-warning me-2 edit-alert-btn';
            editButton.textContent = 'Edit';
            editButton.setAttribute('data-alert-id', alertId);
            controlsDiv.appendChild(editButton);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-sm btn-danger delete-alert-btn';
            deleteButton.textContent = 'Delete';
            deleteButton.setAttribute('data-alert-id', alertId);
            controlsDiv.appendChild(deleteButton);

            cardBody.appendChild(controlsDiv);
            // --- End Admin Controls ---

            card.appendChild(cardBody);
            return card;
        }

        // --- Alert Fetching and Display Logic ---
        function displayAlerts() {
            console.log("Fetching alerts from Firestore...");
            if (loadingIndicator) loadingIndicator.style.display = 'block'; // Show loading
            alertsListDiv.innerHTML = ''; // Clear previous alerts (keep loading indicator separate if needed)

            alertsCollection
                .orderBy('createdAt', 'desc') // Order by creation date, newest first
                .get()
                .then((querySnapshot) => {
                    if (loadingIndicator) loadingIndicator.style.display = 'none'; // Hide loading
                    if (querySnapshot.empty) {
                        alertsListDiv.innerHTML = '<p>No alerts found.</p>';
                        return;
                    }
                    querySnapshot.forEach((doc) => {
                        const alertCard = createAlertCard(doc);
                        alertsListDiv.appendChild(alertCard);
                    });
                    // Re-apply admin UI state after rendering new cards
                    const user = netlifyIdentity.currentUser();
                    console.log("Applying UI state after displaying alerts. User:", user); // DEBUG
                    updateAdminUI(user && checkUserRole(user));
                })
                .catch((error) => {
                    console.error("Error getting alerts: ", error);
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    alertsListDiv.innerHTML = '<p class="text-danger">Error loading alerts. Please try again later.</p>';
                });
        }

        // --- Netlify Identity Logic ---
        netlifyIdentity.init();

        function updateAdminUI(showAdminControls) {
            console.log(`updateAdminUI called with showAdminControls = ${showAdminControls}`); // DEBUG
            // Select ALL admin controls again after potential re-renders
            const currentAdminControls = document.querySelectorAll('.admin-controls');
            console.log(`Found ${currentAdminControls.length} elements with class 'admin-controls'`); // DEBUG
            currentAdminControls.forEach((el, index) => {
                // Use inline style for simplicity here, could use classes too
                el.style.display = showAdminControls ? '' : 'none';
                // console.log(`Element ${index} (${el.tagName}#${el.id || ''}) display set to: ${el.style.display}`); // DEBUG (can be verbose)
            });
            // Toggle top-level login/logout button visibility
             if (loginButton) {
                 loginButton.style.display = showAdminControls ? 'none' : '';
                 console.log(`Login button display set to: ${loginButton.style.display}`); // DEBUG
             } else {
                 console.log("Login button not found"); // DEBUG
             }
        }

        function checkUserRole(user) {
            const allowedRoles = ['admin', 'manager']; // Roles that can manage alerts
            const userRoles = user?.app_metadata?.roles || [];
            const hasRole = userRoles.some(role => allowedRoles.includes(role));
            console.log("Checking user role. User:", user); // DEBUG
            console.log("User roles:", userRoles); // DEBUG
            console.log(`Is admin/manager? ${hasRole}`); // DEBUG
            return hasRole;
        }

        netlifyIdentity.on('init', user => {
            console.log("Netlify Identity init event. User:", user); // DEBUG
            const isAdmin = user && checkUserRole(user);
            updateAdminUI(isAdmin);
            displayAlerts(); // Fetch alerts after knowing login state
        });

        netlifyIdentity.on('login', user => {
            console.log("Netlify Identity login event. User:", user); // DEBUG
            const isAdmin = checkUserRole(user);
            updateAdminUI(isAdmin);
            netlifyIdentity.close();
            // Optionally re-fetch alerts if needed, but usually just showing controls is enough
            // displayAlerts();
        });

        netlifyIdentity.on('logout', () => {
            console.log("Netlify Identity logout event."); // DEBUG
            updateAdminUI(false);
            // Optionally re-fetch alerts if needed
            // displayAlerts();
        });

        // --- CRUD Operations ---

        // ADD Alert
        const saveAlertBtn = document.getElementById('save-alert-btn');
        if (saveAlertBtn) {
            saveAlertBtn.addEventListener('click', () => {
                const title = document.getElementById('alert-title').value.trim();
                const details = document.getElementById('alert-details').value.trim();

                if (!title || !details) {
                    alert('Please fill in both title and details.');
                    return;
                }

                alertsCollection.add({
                    title: title,
                    details: details,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
                })
                .then(() => {
                    console.log("Alert added successfully");
                    if(addAlertModal) addAlertModal.hide();
                    document.getElementById('add-alert-form').reset(); // Reset form
                    displayAlerts(); // Refresh the list
                })
                .catch((error) => {
                    console.error("Error adding alert: ", error);
                    alert('Error adding alert. Please try again.');
                });
            });
        } else {
            console.error("Save Alert button (#save-alert-btn) not found!"); // DEBUG
        }

        // EDIT Alert (Event Delegation on the list)
        alertsListDiv.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-alert-btn')) {
                const alertId = event.target.getAttribute('data-alert-id');
                console.log("Editing alert:", alertId);

                alertsCollection.doc(alertId).get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('edit-alert-id').value = alertId;
                        document.getElementById('edit-alert-title').value = data.title || '';
                        document.getElementById('edit-alert-details').value = data.details || '';
                        if(editAlertModal) editAlertModal.show();
                    } else {
                        console.error("No such document!");
                        alert("Could not find the alert to edit.");
                    }
                }).catch(error => {
                    console.error("Error getting document for edit:", error);
                    alert("Error fetching alert details for editing.");
                });
            }

            // DELETE Alert (Show Confirmation Modal)
            if (event.target.classList.contains('delete-alert-btn')) {
                const alertId = event.target.getAttribute('data-alert-id');
                console.log("Requesting delete for alert:", alertId);
                document.getElementById('delete-alert-id').value = alertId;
                 if(deleteAlertModal) deleteAlertModal.show();
            }
        });

        // UPDATE Alert (Save changes from Edit Modal)
        const updateAlertBtn = document.getElementById('update-alert-btn');
        if (updateAlertBtn) {
            updateAlertBtn.addEventListener('click', () => {
                const alertId = document.getElementById('edit-alert-id').value;
                const title = document.getElementById('edit-alert-title').value.trim();
                const details = document.getElementById('edit-alert-details').value.trim();

                if (!alertId || !title || !details) {
                    alert('Invalid data for update.');
                    return;
                }

                alertsCollection.doc(alertId).update({
                    title: title,
                    details: details,
                    // Optionally update a 'lastUpdatedAt' timestamp here
                    // lastUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log("Alert updated successfully");
                    if(editAlertModal) editAlertModal.hide();
                    displayAlerts(); // Refresh list
                })
                .catch((error) => {
                    console.error("Error updating alert: ", error);
                    alert('Error updating alert. Please try again.');
                });
            });
        } else {
             console.error("Update Alert button (#update-alert-btn) not found!"); // DEBUG
        }

        // CONFIRM Delete
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', () => {
                const alertId = document.getElementById('delete-alert-id').value;
                if (!alertId) {
                    alert('Invalid alert ID for deletion.');
                    return;
                }

                alertsCollection.doc(alertId).delete()
                .then(() => {
                    console.log("Alert deleted successfully");
                    if(deleteAlertModal) deleteAlertModal.hide();
                    displayAlerts(); // Refresh list
                })
                .catch((error) => {
                    console.error("Error deleting alert: ", error);
                    alert('Error deleting alert. Please try again.');
                });
            });
        } else {
            console.error("Confirm Delete button (#confirm-delete-btn) not found!"); // DEBUG
        }

        // --- Initial Load ---
        // displayAlerts() is now called within netlifyIdentity.on('init', ...)
        // to ensure we know the login state before the first render.



    </script>
</body>
</html>
