<!DOCTYPE html>
<html>
<head>
  <title>Alerts Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity.js"></script>
</head>
<body>
  <h1>Alerts Manager</h1>

  <div id="alerts">
    </div>

  <div>
    <h2>Add New Alert</h2>
    <input type="text" id="newAlertText" placeholder="Enter alert text">
    <button id="addAlertButton">Add Alert</button>
  </div>

  <script>
    const alertsDiv = document.getElementById('alerts');
    const newAlertText = document.getElementById('newAlertText');
    const addAlertButton = document.getElementById('addAlertButton');

    let alerts = JSON.parse(localStorage.getItem('alerts')) || [];

    function renderAlerts() {
      alertsDiv.innerHTML = '';
      alerts.forEach((alert, index) => {
        const alertDiv = document.createElement('div');
        alertDiv.textContent = alert;

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.addEventListener('click', () => {
          deleteAlert(index);
        });

        alertDiv.appendChild(deleteButton);
        alertsDiv.appendChild(alertDiv);
      });
    }

    function addAlert(text) {
      alerts.push(text);
      localStorage.setItem('alerts', JSON.stringify(alerts));
      renderAlerts();
    }

    function deleteAlert(index) {
      alerts.splice(index, 1);
      localStorage.setItem('alerts', JSON.stringify(alerts));
      renderAlerts();
    }

    addAlertButton.addEventListener('click', () => {
      const text = newAlertText.value.trim();
      if (text) {
        addAlert(text);
        newAlertText.value = '';
      }
    });

    renderAlerts();

    // Netlify Identity Integration with Role Check
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/";
          });
        }
      });
    }

    function checkAdminRole(callback) {
      const user = netlifyIdentity.currentUser();
      if (user && user.app_metadata && user.app_metadata.roles && user.app_metadata.roles.includes('admin')) {
        callback(true);
      } else {
        callback(false);
      }
    }

    // Modify Add Alert Button Logic
    addAlertButton.addEventListener('click', () => {
      checkAdminRole(isAdmin => {
        if (isAdmin) {
          const text = newAlertText.value.trim();
          if (text) {
            addAlert(text);
            newAlertText.value = '';
          }
        } else {
          alert("You do not have permission to add alerts.");
        }
      });
    });

    // Modify Delete Alert Button Logic
    function renderAlerts() {
      alertsDiv.innerHTML = '';
      alerts.forEach((alert, index) => {
        const alertDiv = document.createElement('div');
        alertDiv.textContent = alert;

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.addEventListener('click', () => {
          checkAdminRole(isAdmin => {
            if (isAdmin) {
              deleteAlert(index);
            } else {
              alert("You do not have permission to delete alerts.");
            }
          });
        });

        alertDiv.appendChild(deleteButton);
        alertsDiv.appendChild(alertDiv);
      });
    }

  </script>
</body>
</html>